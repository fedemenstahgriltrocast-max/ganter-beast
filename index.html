<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Frame-ancestor protections must be applied via HTTP headers (CSP/X-Frame-Options) on the host -->
  <meta http-equiv="Content-Security-Policy"
        content="
        default-src 'self';
        script-src 'self' 'nonce-2726c7f26c' https://static.cloudflareinsights.com;
        script-src-elem 'self' 'nonce-2726c7f26c' https://static.cloudflareinsights.com;
        style-src 'self' 'nonce-2726c7f26c';
        style-src-elem 'self' 'nonce-2726c7f26c';
        img-src 'self' data: https://maps.gstatic.com https://maps.googleapis.com https://maps.google.com;
        connect-src 'self' https://orange-base-dcdc.distraction.workers.dev;
        font-src 'self';
        frame-src https://www.google.com https://maps.google.com;
        base-uri 'self';
        form-action 'self';
        upgrade-insecure-requests;
        block-all-mixed-content
      " />
  <title>Marxia Café y Bocaditos — Desayunos y delivery en Guayaquil</title>
  <meta name="description" content="Desayunos y bocaditos ordena en línea con Entrega en Guayaquil (Saucés, Alborada, Guayacanes, Tarazana Brisas del Río). Pide online: rápido, fresco y confiable." />
  <meta name="robots" content="index,follow" />
  <link rel="canonical" href="https://www.marxia.com/" />
  <meta property="og:title" content="Marxia Café y Bocaditos" />
  <meta property="og:description" content="Pide en línea con Entrega en el Norte de Guayaquil." />
  <meta property="og:url" content="https://www.marxia.com/" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <!-- Removed external Font Awesome dependency; using Unicode icons instead for broader compatibility -->
  <style nonce="2726c7f26c">
    :root{
      --bg:#0e1118; --ink:#ffffff; --muted:#c6cbe3; --card:#161b29;
      --accent:#6f7dff; --accent-2:#1ea97a; --danger:#ff4d6d;
      --line:rgba(255,255,255,.18); --chip:#212840; --input:#0c1020;
      --shadow:0 14px 40px rgba(0,0,0,.35); --edge:16px;

      --ink-light:#0a0e1a; --muted-light:#4a5670; --card-light:#ffffff;
      --line-light:rgba(10,14,26,.12); --input-light:#ffffff; --shadow-light:0 12px 28px rgba(0,0,0,.08);

      /* Seasonal palettes */
      --summer-1:#ff7e5f; --summer-2:#feb47b;
      --spring-1:#a1ffce; --spring-2:#faffd1;

      /* Unified spacing */
      --section-gap:24px; --field-gap:16px;
    }

    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    body{background:var(--bg);color:var(--ink);transition:background .45s ease,color .25s ease}
    html[data-theme="light"] body{
      color:var(--ink-light);
      background:linear-gradient(45deg,var(--summer-1),var(--summer-2),var(--spring-1),var(--spring-2));
      background-size:400% 400%;animation:lightTheme 15s ease infinite;
    }
    @keyframes lightTheme{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    *,*::before,*::after{
      box-sizing:border-box;
      transition:background-color .35s ease,color .35s ease,border-color .35s ease,box-shadow .35s ease
    }

    .wrap{max-width:1100px;margin:0 auto;padding:16px}

    header{position:relative;display:flex;justify-content:center;align-items:center;margin-bottom:12px;min-height:44px}
    header .brand{font-weight:800;letter-spacing:.3px;text-align:center;font-size:36px;line-height:1.1}
    .brand{font-weight:800;letter-spacing:.3px;text-align:center}
    .actions{
      position:fixed;right:10px;top:10px;display:flex;flex-direction:column;gap:6px;align-items:flex-end;z-index:1000;
    }

    .toggle{
      all:unset;cursor:pointer;background:transparent;border:1px solid var(--line);
      padding:8px 14px;border-radius:999px;font-size:14px;line-height:1;color:inherit;
    }
    html[data-theme="light"] .toggle{border-color:var(--line-light)}
    .btn{
      all:unset;cursor:pointer;display:inline-flex;align-items:center;gap:8px;
      padding:10px 14px;border-radius:999px;background:var(--accent);color:#fff;
      font-size:14px;font-weight:700;box-shadow:var(--shadow);line-height:1;
    }
    .btn.is-busy,
    .btn[aria-busy="true"]{
      pointer-events:none;
      opacity:.65;
    }
    .btn.alt{background:var(--accent-2)}

    .chip{
      all:unset;cursor:pointer;padding:8px 16px;border-radius:999px;
      background:var(--chip);color:inherit;border:1px solid var(--line);
      font-weight:600;letter-spacing:.2px;text-align:center;min-width:64px;
      display:flex;align-items:center;justify-content:center;
    }
    .chip.sel{background:var(--accent);color:#fff;box-shadow:var(--shadow)}
    html[data-theme="light"] .chip{background:#eef1fb;border-color:var(--line-light)}
    html[data-theme="light"] .chip.sel{background:var(--accent);color:#fff}
    .chips{display:flex;flex-direction:column;gap:10px;margin-top:10px;align-items:center}
    .chips .chip{width:140px;max-width:100%;padding:8px 0;min-height:36px}
    .click-highlight{
      background:var(--accent) !important;color:#fff !important;
      box-shadow:0 0 0 3px rgba(111,125,255,.65),0 0 0 8px rgba(111,125,255,.25) !important;
    }

    .text-center{text-align:center}
    .font-bold{font-weight:700}
    .text-xl{font-size:1.25rem}
    .mt-8{margin-top:8px}
    .justify-center{justify-content:center}
    .justify-between{justify-content:space-between}
    .fields.single-column{grid-template-columns:1fr}
    .min-w-0{min-width:0}
    .text-sm{font-size:.9rem}

    #clearBtn{
      font-size:12px;font-weight:700;padding:14px 28px;border-radius:999px;
      background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.35);
      color:inherit;box-shadow:var(--shadow);
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
    }
    #clearBtn:hover{background:rgba(255,255,255,.14)}
    html[data-theme="light"] #clearBtn{
      background:rgba(10,14,26,.06);
      border-color:rgba(10,14,26,.18);
      color:var(--ink-light);
      box-shadow:var(--shadow-light);
    }
    html[data-theme="light"] #clearBtn:hover{background:rgba(10,14,26,.12)}

    .location-review{
      margin-top:10px;padding:10px 12px;border-radius:12px;border:1px dashed var(--line);
      font-size:.9rem;line-height:1.4;min-height:38px;display:flex;align-items:center;
    }
    .location-review[data-state="confirmed"]{border-style:solid;border-color:rgba(30,169,122,.55)}
    .location-review[data-state="error"]{border-color:rgba(255,77,109,.65);color:var(--danger)}
    html[data-theme="light"] .location-review{border-color:var(--line-light);background:rgba(10,14,26,.04)}
    html[data-theme="light"] .location-review[data-state="confirmed"]{border-color:rgba(30,169,122,.55)}
    html[data-theme="light"] .location-review[data-state="error"]{border-color:rgba(255,77,109,.55);color:var(--danger)}

    .delivery-label{font-size:12px;font-weight:700;letter-spacing:.15px}

    /* Carousel */
    .carousel{position:relative;margin-top:50px;margin-bottom:var(--section-gap)}
    .track{display:flex;gap:16px;overflow-x:auto;scroll-snap-type:x mandatory;padding-bottom:8px}
    .track::-webkit-scrollbar{height:8px}
    .track::-webkit-scrollbar-thumb{background:rgba(255,255,255,.25);border-radius:999px}
    html[data-theme="light"] .track::-webkit-scrollbar-thumb{background:rgba(20,20,30,.2)}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(0,0,0,.18));border:1px solid var(--line);border-radius:var(--edge);box-shadow:var(--shadow)}
    html[data-theme="light"] .card{background:var(--card-light);border-color:var(--line-light);box-shadow:var(--shadow-light)}
    .product{scroll-snap-align:start;flex:0 0 calc((100% - 32px)/3);min-width:260px;padding:14px;display:flex;flex-direction:column;gap:10px;align-items:center}
    @media (max-width:900px){.product{flex-basis:calc((100% - 16px)/2)}}
    @media (max-width:560px){.product{flex-basis:100%}}
    .product-image{width:100%;height:180px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:800;color:#ffffff;background:repeating-linear-gradient(135deg,#172043,#172043 12px,#0e132a 12px,#0e132a 24px)}
    html[data-theme="light"] .product-image{color:#2b3766;background:repeating-linear-gradient(135deg,#eef2ff,#eef2ff 12px,#dae2ff 12px,#dae2ff 24px)}
    .product-title{font-weight:700}
    .product-desc{font-size:.92rem;text-align:center}
    .product-price{font-weight:800;color:#a9c6ff}
    html[data-theme="light"] .product-price{color:#3344aa}
    .qty{display:inline-flex;align-items:center;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    .qty button{all:unset;cursor:pointer;padding:6px 12px;font-weight:800}
    .qty input{all:unset;width:40px;text-align:center;padding:6px 4px}
    .arrow{position:absolute;top:50%;transform:translateY(-50%);z-index:2}
    .arrow button{all:unset;cursor:pointer;background:var(--chip);border:1px solid var(--line);width:42px;height:42px;border-radius:999px;display:grid;place-items:center;font-weight:900;color:#fff}
    .arrow.left{left:-6px} .arrow.right{right:-6px}
    html[data-theme="light"] .arrow button{background:#eef1fb;border-color:var(--line-light);color:#0a0e1a}

    .panel{padding:14px;margin-top:var(--section-gap)}
    .row{display:flex;gap:10px;align-items:center}
    .row.wrap{flex-wrap:wrap;justify-content:space-between}
    .muted{color:var(--muted)}
    html[data-theme="light"] .muted{color:var(--muted-light)}
    .hr{height:1px;background:linear-gradient(90deg,transparent,var(--line),transparent);margin:12px 0}
    html[data-theme="light"] .hr{background:linear-gradient(90deg,transparent,var(--line-light),transparent)}
    /* Accordion under notice */
    .accordion{overflow:hidden;border-radius:12px;border:1px solid var(--line);margin-top:8px}
    .acc-head{display:flex;justify-content:center;align-items:center;gap:10px;padding:10px 12px;cursor:pointer;background:rgba(255,255,255,.06)}
    .acc-head .acc-icon{transition:transform .25s}
    .menu-title{font-weight:800;font-size:1.5rem;color:#fff}
    html[data-theme="light"] .menu-title{color:#000}
    .acc-head.open .acc-icon{transform:rotate(180deg)}
    .acc-body{max-height:0;overflow:hidden;transition:max-height .35s ease}
    .acc-inner{padding:12px}
    .acc-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:800px){.acc-grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:520px){.acc-grid{grid-template-columns:1fr}}
    .ph{height:120px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#cfe0ff;background:repeating-linear-gradient(135deg,#1b2244,#1b2244 12px,#0e132a 12px,#0e132a 24px)}

    /* Bottom split: KPIs left, totals right */
    .split{display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-top:var(--section-gap)}
    @media (max-width:960px){.split{grid-template-columns:1fr}}
    .kpis{
      display:grid;
      grid-template-columns:minmax(320px,2fr) minmax(240px,1fr);
      grid-template-areas:
        "csat visits"
        "csat sales";
      gap:16px;
      align-items:stretch;
    }
    #kpi1{grid-area:csat}
    #kpi2{grid-area:visits}
    #kpi3{grid-area:sales}
    @media (max-width:960px){
      .kpis{
        grid-template-columns:1fr;
        grid-template-areas:
          "csat"
          "visits"
          "sales";
      }
    }
    .kpi{padding:16px;text-align:center}
    .kpi h4{margin:6px 0 8px 0}
    .csat{display:flex;flex-direction:column;gap:24px;width:100%;height:100%}
    .csat-hero{display:flex;flex-direction:column;align-items:flex-start;gap:14px;width:100%}
    .csat-label{text-transform:uppercase;font-size:.75rem;letter-spacing:.16em;color:var(--muted)}
    .sentiment-score{
      display:inline-block;
      min-width:7ch;
      text-align:right;
      font-weight:700;
      font-variant-numeric:tabular-nums;
      font-feature-settings:'tnum';
      opacity:0;
      color:var(--muted);
      transition:opacity .25s ease,color .25s ease;
    }
    .sentiment-score.visible{opacity:1;color:var(--ink)}
    .sentiment-score.zero{opacity:.6;color:var(--muted)}
    html[data-theme="light"] .sentiment-score.visible{color:var(--ink-light)}
    html[data-theme="light"] .sentiment-score.zero{color:var(--muted-light)}
    .csat-hero-summary{display:flex;align-items:center;gap:16px}
    .csat-face-wrap{display:flex;flex-direction:column;align-items:flex-start;gap:12px;width:100%}
    .csat-rate-row{display:flex;align-items:center;gap:16px;width:100%}
    .csat-rate-row .csat-rate-stars{flex:1;min-width:0}
    .csat-sentiment{font-weight:700;font-size:1.05rem;letter-spacing:.01em;display:flex;align-items:center;gap:10px;text-align:left}
    #csatSentiment{display:inline-flex;align-items:center;gap:10px;transition:font-size .3s ease}
    #csatSentiment.is-emoji{font-size:2.2rem;line-height:1}
    #csatSentiment.is-emoji .csat-emoji{font-size:2.6rem}
    html[data-theme="light"] .csat-sentiment{color:var(--ink-light)}
    .csat-rate-callout{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:12px;
      margin-left:auto;
      padding:14px 18px;
      border-radius:16px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      min-width:180px;
      min-height:0;
      box-shadow:var(--shadow);
      text-align:center;
    }
    .csat-callout-stats{display:flex;flex-direction:column;align-items:center;gap:6px}
    .csat-callout-meta{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      font-size:.95rem;
      color:var(--ink);
      font-weight:600;
    }
    .csat-callout-meta span{font-variant-numeric:tabular-nums}
    .csat-rate-callout .btn{min-width:0;padding:8px 20px;font-size:13px;justify-content:center}
    .csat-rate-note{font-size:.85rem;color:var(--muted);text-align:left;max-width:320px;line-height:1.4;margin:0}
    .csat-average{display:flex;align-items:baseline;gap:8px;color:var(--ink);font-size:2.6rem;font-weight:800;line-height:1}
    .csat-average span{font-variant-numeric:tabular-nums}
    #csatAverageValue,#csatTotalVotes{font-size:2.6rem;line-height:1}
    #csatVotesLabel{font-size:.9rem;letter-spacing:.04em}
    .csat-rate-stars{display:flex;align-items:center;gap:8px;background:linear-gradient(135deg,rgba(255,255,255,.04),rgba(255,255,255,.01));padding:8px 12px;border-radius:16px;border:1px solid var(--line)}
    .csat-star-btn{all:unset;cursor:pointer;width:38px;height:38px;border-radius:50%;display:grid;place-items:center;font-size:18px;font-weight:700;color:var(--muted);background:var(--chip);border:1px solid var(--line);transition:transform .2s ease,box-shadow .25s ease,background .25s ease,color .25s ease;opacity:.7}
    .csat-star-btn:hover,.csat-star-btn:focus-visible{transform:translateY(-2px);background:var(--accent);color:#fff;box-shadow:var(--shadow)}
    .csat-star-btn.active{background:var(--accent);color:#fff;box-shadow:var(--shadow);opacity:1}
    .csat-footer{display:flex;flex-direction:column;align-items:flex-start;gap:10px;width:100%}
    .csat-footer .muted{text-align:left;max-width:260px}
    .csat-breakdown{display:grid;gap:10px;width:100%;justify-items:start}
    .csat-count{display:flex;gap:12px;align-items:center;justify-content:flex-start;padding:10px 12px;border-radius:14px;background:rgba(255,255,255,.04);border:1px solid var(--line);transition:border-color .3s ease,box-shadow .3s ease,transform .3s ease}
    .csat-count.leader{border-color:var(--accent);box-shadow:var(--shadow)}
    .csat-count-body{flex:1;display:flex;flex-direction:column;gap:0}
    .csat-count-top{display:grid;grid-template-columns:minmax(0,1fr) auto auto;align-items:center;gap:10px}
    .csat-count-label{font-weight:700;display:flex;align-items:center;gap:12px}
    .csat-emoji{display:inline-flex;align-items:center;justify-content:center;font-size:1.6rem;line-height:1}
    .csat-count-meta{display:none}
    .csat-count-average,.csat-count-total{font-variant-numeric:tabular-nums;font-weight:700}
    .csat-count-sep{display:none}
    .csat-count-top .csat-count-meta{justify-self:flex-end}
    .csat-count-top .sentiment-score{justify-self:flex-end}
    @media (max-width:520px){
      .csat-count-top{grid-template-columns:minmax(0,1fr);}
      .csat-count-top .csat-count-meta,.csat-count-top .sentiment-score{justify-self:flex-start}
    }
    html[data-theme="light"] .csat-count{background:rgba(10,14,26,.05);border-color:var(--line-light)}
    html[data-theme="light"] .csat-count.leader{border-color:var(--accent);box-shadow:var(--shadow-light)}
    html[data-theme="light"] .csat-count-meta{color:var(--muted-light)}
    html[data-theme="light"] .csat-rate-note{color:var(--muted-light)}
    html[data-theme="light"] .csat-callout-meta{color:var(--ink-light)}
    html[data-theme="light"] .csat-rate-callout{
      background:rgba(10,14,26,.04);
      border-color:var(--line-light);
      box-shadow:var(--shadow-light);
    }
    @media (max-width:900px){
      .csat-hero{align-items:center;text-align:center}
      .csat-hero-summary{flex-direction:column;align-items:center}
      .csat-face-wrap{width:100%;align-items:center}
      .csat-rate-stars{justify-content:center}
      .csat-rate-row{flex-direction:column;align-items:center;gap:12px}
      .csat-rate-callout{margin-left:0;width:100%;max-width:260px}
      .csat-rate-note{text-align:center}
      .csat-footer{align-items:center;text-align:center}
    }
    html[data-theme="light"] .csat-average{color:var(--ink-light)}
    html[data-theme="light"] .csat-rate-stars{background:linear-gradient(135deg,rgba(10,14,26,.04),rgba(10,14,26,.02));border-color:var(--line-light)}
    html[data-theme="light"] .csat-star-btn{background:#eef1fb;border-color:var(--line-light);color:var(--muted-light)}
    html[data-theme="light"] .csat-star-btn.active,html[data-theme="light"] .csat-star-btn:hover,html[data-theme="light"] .csat-star-btn:focus-visible{background:var(--accent);color:#fff}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .counter{margin-bottom:8px;font-size:.9rem;text-align:left;line-height:1.4}
    .counter div{display:flex;justify-content:space-between}
    .counter [data-empty]{opacity:.6}
    .kpi canvas{width:100%;max-width:220px;height:80px}

    .totals{padding:16px}
    .delivery-time{display:flex;flex-direction:column;align-items:center;text-align:center;gap:6px;margin-bottom:12px}
    .totals .line{display:flex;justify-content:space-between;align-items:center;margin:6px 0}
    .totals strong{font-weight:800}

    /* FAB only for chat and pay */
    .fab{position:fixed;right:20px;bottom:20px;display:flex;flex-direction:column;gap:10px;z-index:1000}
    .fab a,.fab button{border-radius:50px;padding:8px 14px;font-size:14px;font-weight:700;line-height:1;box-shadow:0 4px 10px rgba(0,0,0,.3)}
    .fab a{background:#25D366;color:#fff;text-decoration:none}

    /* Modal + inputs */
    dialog{border:none;padding:0;background:transparent;width:min(96vw,600px)}
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .modal{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);display:flex;flex-direction:column;max-height:90vh;overflow:hidden;width:100%}
    html[data-theme="dark"] .modal{background:#0b0f16;border-color:rgba(255,255,255,.28);color:#ffffff}
    html[data-theme="light"] .modal{background:#fff;border-color:var(--line-light);box-shadow:var(--shadow-light)}
    .modal header,.modal footer{padding:12px 14px}
    .modal header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--line)}
    .modal main{padding:14px;display:grid;gap:14px;overflow-y:auto;flex:1}
    .modal footer{display:flex;flex-direction:column;gap:12px;align-items:flex-end}
    .footer-actions{display:flex;gap:10px;justify-content:flex-end;width:100%}
    #orderItems{max-height:200px;overflow-y:auto}
    @media(max-width:640px){dialog{width:100vw;height:100vh;border-radius:0}}
    .close{all:unset;cursor:pointer;font-weight:800}

    .fields{display:grid;grid-template-columns:1fr 1fr;column-gap:var(--field-gap);row-gap:var(--field-gap);margin-top:10px}
    .fields.full{grid-template-columns:1fr auto}
    .fields + .fields{margin-top:12px}
    @media (max-width:640px){.fields,.fields.full{grid-template-columns:1fr}}

    input,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:var(--input);color:var(--ink);caret-color:#fff}
    input::placeholder,textarea::placeholder{color:rgba(255,255,255,.92)}
    html[data-theme="light"] input,html[data-theme="light"] textarea{background:var(--input-light);border-color:var(--line-light);color:var(--ink-light)}
    html[data-theme="light"] input::placeholder,html[data-theme="light"] textarea::placeholder{color:rgba(10,14,26,.6)}
    .items{display:grid;gap:10px}
    .item-row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .inline-qty{display:inline-flex;align-items:center;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    .inline-qty button{all:unset;cursor:pointer;padding:6px 10px;font-weight:800}
    .inline-qty span{display:inline-block;min-width:28px;text-align:center}
    html[data-theme="dark"] .muted, html[data-theme="dark"] .panel *{color:#fff}
    html[data-theme="dark"] input,html[data-theme="dark"] textarea{color:#fff;border-color:rgba(255,255,255,.28)}
    .location-hint{margin:6px 0 0 0;font-size:.9rem;line-height:1.45}
    .disclaimer{font-size:.9rem;color:var(--danger);text-align:right;width:100%}
    .disclaimer[hidden]{display:none}
    .location-modal main{padding:14px;display:grid;gap:14px;overflow-y:auto;max-height:70vh}
    .location-modal header{border-bottom:1px solid var(--line)}
    .location-modal footer{width:100%}
    .map-toggle{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:10px 0}
    .map-toggle .chip{min-width:0;padding:8px 14px}
    .map-links{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:10px}
    .map-links .toggle{font-size:12px;padding:8px 14px}
    .map-links .toggle.active{border-color:var(--accent);color:var(--accent)}
    html[data-theme="light"] .map-links .toggle.active{border-color:var(--accent);color:var(--accent)}
    .map-links .toggle.disabled{opacity:.5;pointer-events:none;cursor:default}
    .map-frame-wrap{width:100%}
    .map-frame{width:100%;height:260px;border:0;border-radius:12px;background:#0b0f16}
    html[data-theme="light"] .map-frame{background:#eef1fb}
    .map-status{font-size:.92rem;color:var(--muted);min-height:1.2em}
    .map-status.alert{color:var(--danger)}
  </style>
</head>
  <script type="module" nonce="2726c7f26c">
  /* === CONSTANTS (point to your Worker and its public enc key) === */
  const ENDPOINT = 'https://orange-base-dcdc.distraction.workers.dev';
  const ENC_P256_KID = 'a973cb4c-c7ab-4e2f-8f54-0b40cbc24062';
  const ENC_P256_PUB_JWK = {
    "crv":"P-256","ext":true,"key_ops":[],"kty":"EC",
    "x":"FdOtddmDnfbEmTgEJ51mBui-WDug6pW7UGAalHYfM0I",
    "y":"ziKmEaTpbLhuukXQTjs9f3EiPS5QaJbcR1Zg-XDLFiM"
  };

  /* === helpers === */
  const sanitizeText = (value)=>{
    if(typeof value !== 'string') return '';
    return value.normalize('NFKC').replace(/\p{C}/gu,'').trim();
  };
  const toNumber = (value)=>{
    const num = Number(value);
    return Number.isFinite(num) ? num : 0;
  };
  const encInfo = new TextEncoder().encode('enc.v1/ekey');
  const b64u = (bytes)=>{ let s=''; for(const b of bytes) s+=String.fromCharCode(b); return btoa(s).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); };
  async function sha256Hex(s){ const buf=await crypto.subtle.digest('SHA-256', new TextEncoder().encode(s)); return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join(''); }

  /* === build sealed envelope for the Worker === */
  async function sealForWorker(payload){
    // ephemeral P-256 for this transaction
    const eph = await crypto.subtle.generateKey({ name:'ECDH', namedCurve:'P-256' }, true, ['deriveBits']);
    const epkJwk = await crypto.subtle.exportKey('jwk', eph.publicKey);

    // import worker public key
    const serverPub = await crypto.subtle.importKey('jwk', ENC_P256_PUB_JWK, { name:'ECDH', namedCurve:'P-256' }, false, []);
    const shared   = await crypto.subtle.deriveBits({ name:'ECDH', public: serverPub }, eph.privateKey, 256);

    const salt = crypto.getRandomValues(new Uint8Array(16));
    const hkdfBase = await crypto.subtle.importKey('raw', new Uint8Array(shared), 'HKDF', false, ['deriveKey']);
    const aesKey = await crypto.subtle.deriveKey(
      { name:'HKDF', hash:'SHA-256', salt, info: encInfo },
      hkdfBase, { name:'AES-GCM', length:256 }, false, ['encrypt']
    );

    const iv = crypto.getRandomValues(new Uint8Array(12));
    const pt = new TextEncoder().encode(JSON.stringify(payload));
    const ct = await crypto.subtle.encrypt({ name:'AES-GCM', iv }, aesKey, pt);

    // tamper-evident hashes
    const asset_id = await sha256Hex(JSON.stringify({
      policy: payload.policy,
      items: payload.cart.items.map(i=>({id:i.id,name:i.name,qty:i.qty,unit:i.unit})),
      total: payload.cart.total
    }));
    const asset_auth = await sha256Hex(JSON.stringify(payload));

    return {
      kid: ENC_P256_KID,
      epk: { kty:'EC', crv:'P-256', x: epkJwk.x, y: epkJwk.y, ext:true, key_ops:[] },
      iv: b64u(iv),
      salt: b64u(salt),
      ciphertext: b64u(new Uint8Array(ct)),
      asset_id,
      asset_auth
    };
  }

  async function postEnvelope(envelope){
    const res = await fetch(`${ENDPOINT}/init`, {
      method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(envelope)
    });
    return res.json();
  }

  /**
   * Build an encrypted envelope for the Worker using an order payload that
   * mirrors the checkout data collected in the main application flow.
   * The function returns the Worker response (usually { ok, token }).
   */
  async function initializeWorkerTransaction(orderPayload, options={}){
    if(!ENDPOINT){
      return { ok:false, skipped:true, reason:'missing_endpoint' };
    }
    if(!orderPayload || typeof orderPayload!=='object'){
      throw new TypeError('orderPayload must be an object');
    }
    const policy = typeof options.policy==='string' && options.policy.trim()
      ? options.policy.trim()
      : 'OPS';
    const cartItems = Array.isArray(orderPayload?.cart?.items)
      ? orderPayload.cart.items.filter(item=>item && Number(item.qty)>0)
      : [];
    if(!cartItems.length){
      return { ok:false, skipped:true, reason:'empty_cart' };
    }
    const sanitizedItems = cartItems.map(item=>({
      id: item.id,
      name: sanitizeText(item.name||''),
      desc: sanitizeText(item.desc||''),
      qty: Number(item.qty)||0,
      unit: toNumber(item.unit)
    }));
    const delivery = orderPayload.delivery || {};
    const customer = orderPayload.customer || {};
    const preparedPayload = {
      policy,
      lang: sanitizeText(orderPayload.lang||lang||'es'),
      timestamp: orderPayload.timestamp || new Date().toISOString(),
      business: orderPayload.business || BUSINESS,
      customer: {
        firstName: sanitizeText(customer.firstName),
        lastName: sanitizeText(customer.lastName),
        idNumber: sanitizeText(customer.idNumber),
        phone: sanitizeText(customer.phone),
        email: sanitizeText(customer.email),
        address: sanitizeText(customer.address),
        city: sanitizeText(customer.city),
        locationConfirmed: Boolean(customer.locationConfirmed)
      },
      delivery: {
        minutes: Number(delivery.minutes)||0,
        fee: toNumber(delivery.fee),
        included: delivery.included!==false,
        display: sanitizeText(
          delivery.display
          || (typeof formatDeliveryTime==='function' ? formatDeliveryTime(deliveryMinutes) : '')
        )
      },
      cart: {
        items: sanitizedItems,
        subtotal: toNumber(orderPayload?.cart?.subtotal),
        vat: toNumber(orderPayload?.cart?.vat),
        delivery: toNumber(orderPayload?.cart?.delivery),
        total: toNumber(orderPayload?.cart?.total),
        instructions: sanitizeText(orderPayload?.cart?.instructions)
      }
    };
    if(customer && typeof customer.mapLinks==='object' && customer.mapLinks!==null){
      preparedPayload.customer.mapLinks = customer.mapLinks;
    }
    const gpsSource = (customer && typeof customer.gps==='object' && customer.gps)
      ? customer.gps
      : (typeof gps==='object' && gps ? gps : null);
    if(gpsSource && typeof gpsSource.lat==='number' && typeof gpsSource.lng==='number'){
      preparedPayload.customer.gps = {
        lat: Number(gpsSource.lat),
        lng: Number(gpsSource.lng),
        confirmedAt: gpsSource.confirmedAt || null
      };
    }
    try{
      const envelope = await sealForWorker(preparedPayload);
      const response = await postEnvelope(envelope);
      if(response && typeof response==='object'){
        return response;
      }
      return { ok:true };
    }catch(err){
      console.error('Worker transaction initialization failed',err);
      throw err;
    }
  }

  window.initializeWorkerTransaction = initializeWorkerTransaction;
</script>
<body>
  <div class="wrap">
    <header>
      <div class="brand" data-en="Marxia Cafe y Bocaditos" data-es="Marxia Cafe y Bocaditos">Marxia Cafe y Bocaditos</div>
      <div class="actions">
        <button id="langBtn" class="toggle" aria-label="Toggle Language">ES</button>
        <button id="themeBtn" class="toggle" aria-label="Toggle Theme">Dark</button>
      </div>
    </header>

    <!-- PRODUCT CAROUSEL -->
    <section class="carousel">
      <div class="arrow left"><button id="prev" aria-label="Previous">‹</button></div>
      <div class="arrow right"><button id="next" aria-label="Next">›</button></div>
      <div id="track" class="track" aria-live="polite"></div>
    </section>

    <!-- DELIVERY NOTICE + ACCORDION -->
    <section class="panel card">
      <div class="muted text-center font-bold text-xl"
           data-en="We deliver only: Sauces, Alborada, Guayacanes, Tarazana Brisas del Rio"
           data-es="Entregamos en: Saucés, Alborada, Guayacanes, Tarazana Brisas del Rio">
        We deliver only: Sauces, Alborada, Guayacanes, Tarazana Brisas del Rio
      </div>

      <div id="zoneAcc" class="accordion">
        <div class="acc-head" role="button" aria-expanded="false">
          <span class="acc-icon" aria-hidden="true">▾</span>
          <span class="menu-title" data-en="Our Menu" data-es="Nuestro Menú">Our Menu</span>
          <span class="acc-icon" aria-hidden="true">▾</span>
        </div>
        <div class="acc-body">
          <div class="acc-inner">
            <div class="acc-grid">
              <div class="ph">Photo A</div>
              <div class="ph">Photo B</div>
              <div class="ph">Photo C</div>
            </div>
            <div class="hr"></div>
            <div class="muted" data-en="Add any description or conditions here."
                 data-es="Agregue aquí cualquier descripción o condición.">Add any description or conditions here.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- BOTTOM SPLIT: KPIs LEFT + TOTALS RIGHT -->
    <section class="split">
      <div class="kpis">
        <div class="card kpi" id="kpi1">
          <h4 data-en="Customer Satisfaction" data-es="Satisfacción del cliente">Customer Satisfaction</h4>
          <div class="csat">
            <div class="csat-hero">
              <div class="csat-hero-summary">
                <div class="csat-face-wrap">
                  <div class="csat-sentiment" role="status" aria-live="polite">
                    <span id="csatSentiment" data-default-en="Select a rating" data-default-es="Seleccione una calificación">Select a rating</span>
                  </div>
                  <div class="csat-rate-row">
                    <div class="csat-rate-stars" role="group" aria-label="Rate customer satisfaction">
                      <button type="button" class="csat-star-btn" aria-label="1 star" data-val="1">★</button>
                      <button type="button" class="csat-star-btn" aria-label="2 stars" data-val="2">★</button>
                      <button type="button" class="csat-star-btn" aria-label="3 stars" data-val="3">★</button>
                      <button type="button" class="csat-star-btn" aria-label="4 stars" data-val="4">★</button>
                      <button type="button" class="csat-star-btn" aria-label="5 stars" data-val="5">★</button>
                    </div>
                    <div class="csat-rate-callout">
                      <div class="csat-callout-stats" aria-live="polite">
                        <div class="csat-average">
                          <span id="csatAverageValue">0.00</span><span>/5</span>
                        </div>
                        <div class="csat-callout-meta">
                          <span id="csatTotalVotes">0</span>
                          <span id="csatVotesLabel" data-en="votes" data-es="votos">votes</span>
                        </div>
                      </div>
                      <button class="btn" id="rateBtn" data-en="Rate" data-es="Calificar">Rate</button>
                    </div>
                  </div>
                  <p class="csat-rate-note" data-en="Share your experience to keep this score strong." data-es="Comparte tu experiencia para mantener este puntaje.">
                    Share your experience to keep this score strong.
                  </p>
                </div>
              </div>
            </div>
            <div class="csat-footer">
              <div class="csat-breakdown" id="csatCounts" role="list" aria-label="Customer satisfaction breakdown">
                <div class="csat-count" role="listitem" data-val="5" data-label-en="Delighted" data-label-es="Encantado">
                  <div class="csat-count-body">
                    <div class="csat-count-top">
                      <span class="csat-count-label" data-en="Delighted" data-es="Encantado" data-emoji-label="true">
                        <span class="csat-emoji" aria-hidden="true">🤩</span>
                      </span>
                      <div class="csat-count-meta">
                        <span class="csat-count-average">0.00</span><span>/5</span>
                        <span class="csat-count-sep">•</span>
                        <span class="csat-count-total">0</span>
                        <span class="csat-count-votes-label" data-en="votes" data-es="votos">votes</span>
                      </div>
                      <span class="sentiment-score zero">0</span>
                    </div>
                  </div>
                </div>
                <div class="csat-count" role="listitem" data-val="4" data-label-en="Happy" data-label-es="Feliz">
                  <div class="csat-count-body">
                    <div class="csat-count-top">
                      <span class="csat-count-label" data-en="Happy" data-es="Feliz" data-emoji-label="true">
                        <span class="csat-emoji" aria-hidden="true">🙂</span>
                      </span>
                      <div class="csat-count-meta">
                        <span class="csat-count-average">0.00</span><span>/5</span>
                        <span class="csat-count-sep">•</span>
                        <span class="csat-count-total">0</span>
                        <span class="csat-count-votes-label" data-en="votes" data-es="votos">votes</span>
                      </div>
                      <span class="sentiment-score zero">0</span>
                    </div>
                  </div>
                </div>
                <div class="csat-count" role="listitem" data-val="3" data-label-en="Neutral" data-label-es="Neutral">
                  <div class="csat-count-body">
                    <div class="csat-count-top">
                      <span class="csat-count-label" data-en="Neutral" data-es="Neutral" data-emoji-label="true">
                        <span class="csat-emoji" aria-hidden="true">😐</span>
                      </span>
                      <div class="csat-count-meta">
                        <span class="csat-count-average">0.00</span><span>/5</span>
                        <span class="csat-count-sep">•</span>
                        <span class="csat-count-total">0</span>
                        <span class="csat-count-votes-label" data-en="votes" data-es="votos">votes</span>
                      </div>
                      <span class="sentiment-score zero">0</span>
                    </div>
                  </div>
                </div>
                <div class="csat-count" role="listitem" data-val="2" data-label-en="Unhappy" data-label-es="Descontento">
                  <div class="csat-count-body">
                    <div class="csat-count-top">
                      <span class="csat-count-label" data-en="Unhappy" data-es="Descontento" data-emoji-label="true">
                        <span class="csat-emoji" aria-hidden="true">🙁</span>
                      </span>
                      <div class="csat-count-meta">
                        <span class="csat-count-average">0.00</span><span>/5</span>
                        <span class="csat-count-sep">•</span>
                        <span class="csat-count-total">0</span>
                        <span class="csat-count-votes-label" data-en="votes" data-es="votos">votes</span>
                      </div>
                      <span class="sentiment-score zero">0</span>
                    </div>
                  </div>
                </div>
                <div class="csat-count" role="listitem" data-val="1" data-label-en="Frustrated" data-label-es="Frustrado">
                  <div class="csat-count-body">
                    <div class="csat-count-top">
                      <span class="csat-count-label" data-en="Frustrated" data-es="Frustrado" data-emoji-label="true">
                        <span class="csat-emoji" aria-hidden="true">😠</span>
                      </span>
                      <div class="csat-count-meta">
                        <span class="csat-count-average">0.00</span><span>/5</span>
                        <span class="csat-count-sep">•</span>
                        <span class="csat-count-total">0</span>
                        <span class="csat-count-votes-label" data-en="votes" data-es="votos">votes</span>
                      </div>
                      <span class="sentiment-score zero">0</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card kpi" id="kpi2">
          <h4 data-en="Visits" data-es="Visitas">Visits</h4>
          <div class="counter">
            <div><span data-en="Today" data-es="Hoy">Today</span>: <span id="visitsToday">—</span></div>
            <div><span data-en="This Month" data-es="Este Mes">This Month</span>: <span id="visitsMonth">—</span></div>
            <div><span data-en="Last Year" data-es="El año pasado">Last Year</span>: <span id="visitsYear">—</span></div>
          </div>
          <canvas id="visitsChart" width="180" height="80" aria-hidden="true"></canvas>
          <div class="muted mt-8" data-en="Foot & site traffic." data-es="Tráfico en local y web.">Foot & site traffic.</div>
        </div>

        <div class="card kpi" id="kpi3">
          <h4 data-en="Online Sales" data-es="Ventas en línea">Online Sales</h4>
          <div class="counter">
            <div><span data-en="Today" data-es="Hoy">Today</span>: <span id="salesToday">0</span></div>
            <div><span data-en="This Month" data-es="Este Mes">This Month</span>: <span id="salesMonth">0</span></div>
            <div><span data-en="Last Year" data-es="El año pasado">Last Year</span>: <span id="salesYear">0</span></div>
          </div>
          <canvas id="salesChart" width="180" height="80" aria-hidden="true"></canvas>
          <div class="muted mt-8" data-en="Room to grow." data-es="Espacio para crecer.">Room to grow.</div>
        </div>
      </div>

      <!-- TOTALS -->
      <div class="card totals">
        <div class="line"><span class="muted" data-en="Subtotal" data-es="Subtotal">Subtotal</span><strong id="t_sub">$0.00</strong></div>
        <div class="line"><span class="muted" data-en="VAT 15%" data-es="IVA 15%">VAT 15%</span><strong id="t_tax">$0.00</strong></div>
        <div class="line"><span class="muted" data-en="Delivery 3.00" data-es="Entrega 3.00">Delivery 3.00</span><strong id="t_del">$0.00</strong></div>
        <div class="line"><span class="muted" data-en="Total" data-es="Total">Total</span><strong id="t_total">$0.00</strong></div>

        <div class="hr"></div>
        <div class="row justify-center">
          <button id="clearBtn" class="toggle" data-en="Clear Cart" data-es="Vaciar Carrito">Clear Cart</button>
        </div>

        <div class="hr"></div>
        <div class="delivery-time">
          <div class="muted delivery-label" data-en="Delivery Time" data-es="Tiempo de entrega">Delivery Time</div>
          <strong id="t_deliveryTime" aria-live="polite">45 min</strong>
        </div>
        <div class="chips" id="delTimes">
          <button class="chip sel" data-min="45">45 min</button>
          <button class="chip" data-min="60">1 hr</button>
          <button class="chip" data-min="90">1 hr 30 min</button>
        </div>
      </div>
    </section>
  </div>

  <!-- FABs for Chat and Pay -->
  <div class="fab">
    <a id="chatFab" href="https://wa.me/593958741463" target="_blank" rel="noopener noreferrer" data-en="💬 Chat" data-es="💬 Chat">💬 Chat</a>
    <button id="fabPay" class="btn alt" data-en="Pay" data-es="Pagar">Pay</button>
  </div>

  <!-- ORDER MODAL -->
  <dialog id="orderDlg">
    <div class="modal">
      <header>
        <div class="brand" data-en="Order Review" data-es="Revisión de Pedido">Order Review</div>
        <button class="close" id="closeDlg" aria-label="Close">×</button>
      </header>
      <main>
        <section>
          <div id="orderItems" class="items"></div>
          <div class="hr"></div>
          <div class="row justify-between">
            <div class="muted delivery-label" data-en="Delivery Time" data-es="Tiempo de entrega">Delivery Time</div>
            <strong id="m_deliveryTime">45 min</strong>
          </div>
          <div class="row justify-between"><div class="muted" data-en="Subtotal" data-es="Subtotal">Subtotal</div><strong id="m_sub">$0.00</strong></div>
          <div class="row justify-between"><div class="muted" data-en="VAT 15%" data-es="IVA 15%">VAT 15%</div><strong id="m_tax">$0.00</strong></div>
          <div class="row justify-between"><div class="muted" data-en="Delivery 3.00 (included)" data-es="Entrega 3.00 (incluida)">Delivery 3.00 (included)</div><strong id="m_del">$0.00</strong></div>
          <div class="row justify-between"><div class="muted" data-en="Total" data-es="Total">Total</div><strong id="m_total">$0.00</strong></div>
          <div id="locationReview" class="location-review" aria-live="polite" data-state="idle" data-en="We will ask you to authorize and confirm your delivery location after you click “Confirm Transaction.”" data-es="Le pediremos autorizar y confirmar su ubicación de entrega después de presionar “Confirmar transacción”.">We will ask you to authorize and confirm your delivery location after you click “Confirm Transaction.”</div>
        </section>

        <div class="hr"></div>

        <section>
          <div class="muted" data-en="Instructions" data-es="Instrucciones">Instructions</div>
          <textarea id="instructions" rows="3" data-ph-en="No onions, leave at gate, etc." data-ph-es="Sin cebolla, dejar en la puerta, etc." placeholder="No onions, leave at gate, etc."></textarea>
        </section>

        <div class="hr"></div>
        <section>
          <div class="muted" data-en="Customer Information" data-es="Información del Cliente">Información del Cliente</div>
          <div class="fields">
            <input id="firstName" required data-ph-en="Name" data-ph-es="Nombre" placeholder="Name" />
            <input id="lastName" required data-ph-en="Last name" data-ph-es="Apellido" placeholder="Last name" />
          </div>
          <div class="fields">
            <input id="idNumber" required data-ph-en="Céd / RUC" data-ph-es="Céd / RUC" placeholder="Céd / RUC" />
            <input id="phone" required data-ph-en="+593 9xx xxx xxx" data-ph-es="+593 9xx xxx xxx" placeholder="+593 9xx xxx xxx" inputmode="tel" />
          </div>
          <div class="fields single-column">
            <input id="email" required type="email" data-ph-en="Email" data-ph-es="Correo electrónico" placeholder="Email" />
          </div>
          <div class="fields single-column">
            <input id="address" required class="min-w-0" data-ph-en="Address" data-ph-es="Dirección" placeholder="Address" />
          </div>
          <p class="muted location-hint" data-en="After you review your order, click “Confirm Transaction” and we will guide you to authorize and confirm your delivery location on Google Maps." data-es="Después de revisar su pedido, haga clic en “Confirmar transacción” y le guiaremos para autorizar y confirmar su ubicación de entrega en Google Maps.">After you review your order, click “Confirm Transaction” and we will guide you to authorize and confirm your delivery location on Google Maps.</p>
        </section>
      </main>
      <footer>
        <div class="footer-actions">
          <button class="toggle" id="cancelBtn" data-en="Cancel" data-es="Cancelar">Cancel</button>
          <button class="toggle" id="clearReviewBtn" data-en="Clear order" data-es="Limpiar pedido">Clear order</button>
          <button class="btn alt" id="confirmBtn" data-en="Confirm Transaction" data-es="Confirmar transacción">Confirm Transaction</button>
        </div>
        <div id="confirmDisclaimer" class="disclaimer" hidden aria-live="assertive"></div>
      </footer>
    </div>
  </dialog>

  <dialog id="locAuthDlg">
    <div class="modal location-modal">
      <header>
        <div class="brand" data-en="Authorize Delivery Location" data-es="Autorizar ubicación de entrega">Authorize Delivery Location</div>
        <button class="close" id="closeLocAuth" aria-label="Close">×</button>
      </header>
      <main>
        <p class="muted" data-en="To protect your order we only request your delivery location once you choose to pay. Authorize access and we will open Google Maps so you can verify or adjust the pin." data-es="Para proteger su pedido solo solicitamos su ubicación de entrega cuando decide pagar. Autorice el acceso y abriremos Google Maps para que verifique o ajuste el punto.">To protect your order we only request your delivery location once you choose to pay. Authorize access and we will open Google Maps so you can verify or adjust the pin.</p>
        <div id="locAuthStatus" class="map-status" aria-live="polite"></div>
      </main>
      <footer>
        <div class="footer-actions">
          <button class="toggle" id="locAuthCancel" data-en="Not now" data-es="Ahora no">Not now</button>
          <button class="btn alt" id="authorizeLocationBtn" data-en="Authorize location" data-es="Autorizar ubicación">Authorize location</button>
        </div>
      </footer>
    </div>
  </dialog>

  <dialog id="mapDlg">
    <div class="modal location-modal">
      <header>
        <div class="brand" data-en="Confirm Delivery Location" data-es="Confirmar ubicación de entrega">Confirm Delivery Location</div>
        <button class="close" id="closeMap" aria-label="Close">×</button>
      </header>
      <main>
        <p class="muted" data-en="You must confirm your \"Order Delivery Location\" before we can send your order." data-es="Debe confirmar su \"Ubicación de Entrega\" antes de enviar su pedido.">You must confirm your "Order Delivery Location" before we can send your order.</p>
        <div class="map-toggle" role="tablist">
          <button type="button" class="chip sel" data-map-tab="desktop" aria-pressed="true" data-en="PC / Laptop map" data-es="Mapa PC / Laptop">PC / Laptop map</button>
          <button type="button" class="chip" data-map-tab="mobile" aria-pressed="false" data-en="Mobile / Tablet map" data-es="Mapa móvil / Tablet">Mobile / Tablet map</button>
        </div>
        <div class="map-links">
          <a
            class="toggle disabled"
            data-map-link="desktop"
            target="_blank"
            rel="noopener noreferrer"
            aria-disabled="true"
            data-en="Open desktop map in Google Maps"
            data-es="Abrir mapa de escritorio en Google Maps"
          >Open desktop map in Google Maps</a>
          <a
            class="toggle disabled"
            data-map-link="mobile"
            target="_blank"
            rel="noopener noreferrer"
            aria-disabled="true"
            data-en="Open mobile/tablet map in Google Maps"
            data-es="Abrir mapa móvil/tablet en Google Maps"
          >Open mobile/tablet map in Google Maps</a>
        </div>
        <div class="map-frame-wrap">
          <iframe id="mapFrame" class="map-frame" title="Delivery location map" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
        <div id="mapStatus" class="map-status" aria-live="polite"></div>
      </main>
      <footer>
        <div class="footer-actions">
          <button class="toggle" id="mapCancel" data-en="Cancel" data-es="Cancelar">Cancel</button>
          <button class="btn alt" id="mapConfirm" data-en="Confirm Location" data-es="Confirmar ubicación">Confirm Location</button>
        </div>
      </footer>
    </div>
  </dialog>

  <script nonce="2726c7f26c">
    /* CONFIG */
    const CLOUDFLARE_WORKER_URL = "https://orange-base-dcdc.distraction.workers.dev/";
    const WORKER_CSAT_URL = 'https://orange-base-dcdc.distraction.workers.dev';

    const joinWorkerPath=(base,segment='')=>{
      if(!base) return '';
      const trimmedBase=String(base).trim();
      const trimmedSegment=String(segment||'').trim();
      try{
        const url=new URL(trimmedBase);
        const basePath=url.pathname.replace(/\/+$/,'');
        const normalizedBase=basePath.replace(/^\/+/, '').replace(/\/+$/,'');
        const normalizedSegment=trimmedSegment?trimmedSegment.replace(/^\/+/, '').replace(/\/+$/,''):'';
        const pathParts=[];
        if(normalizedBase) pathParts.push(normalizedBase);
        if(normalizedSegment) pathParts.push(normalizedSegment);
        url.pathname=pathParts.length?`/${pathParts.join('/')}`:'/';
        url.search='';
        url.hash='';
        const href=url.href;
        if(pathParts.length===0) return url.origin;
        return href.endsWith('/')?href.slice(0,-1):href;
      }catch{
        const baseNoSlash=trimmedBase.replace(/\/+$/,'');
        if(!trimmedSegment) return baseNoSlash;
        const segmentNoSlash=trimmedSegment.replace(/^\/+/, '');
        return segmentNoSlash?`${baseNoSlash}/${segmentNoSlash}`:baseNoSlash;
      }
    };

    const normalizeUrlCandidate=value=>{
      const raw=String(value||'').trim();
      if(!raw) return '';
      try{
        const url=new URL(raw);
        url.hash='';
        if(!url.search) return url.href.replace(/\/+$/,'');
        return url.href;
      }catch{
        return raw;
      }
    };

    const APPS_SCRIPT_URL = "";       // optional

    const WORKER_CSAT_BASE = joinWorkerPath(WORKER_CSAT_URL,'');
    const MAX_PENDING = 25;
    let pending = [];
    const CSAT_SUBMIT_ENDPOINT = joinWorkerPath(WORKER_CSAT_BASE,'csat');
    const CSAT_VISIT_ENDPOINT = joinWorkerPath(WORKER_CSAT_BASE,'visit');
    const CSAT_STATS_ENDPOINTS = (()=>{
      const set=new Set();
      const add=url=>{ const normalized=normalizeUrlCandidate(url); if(normalized) set.add(normalized); };
      add(joinWorkerPath(WORKER_CSAT_BASE,'csat'));
      add(joinWorkerPath(WORKER_CSAT_BASE,'stats'));
      if(WORKER_CSAT_URL){
        try{
          const parsed=new URL(WORKER_CSAT_URL);
          add(`${parsed.origin}/csat`);
          add(`${parsed.origin}/stats`);
        }catch{}
      }
      if(APPS_SCRIPT_URL){
        const trimmed=String(APPS_SCRIPT_URL).trim();
        if(trimmed){
          try{
            const statsUrl=new URL(trimmed);
            statsUrl.searchParams.set('app','csat');
            statsUrl.searchParams.set('stats','1');
            add(statsUrl.toString());
          }catch{
            const base=trimmed.replace(/\/+$/,'');
            add(`${base}?app=csat&stats=1`);
          }
        }
      }
      return Array.from(set);
    })();

    const WORKER_CSAT_ENDPOINTS = (()=>{
      const endpoints=new Set();
      const add=url=>{
        const normalized=normalizeUrlCandidate(url);
        if(normalized) endpoints.add(normalized);
      };
      add(CSAT_SUBMIT_ENDPOINT);
      add(WORKER_CSAT_BASE);
      if(WORKER_CSAT_URL){
        try{
          const parsed=new URL(WORKER_CSAT_URL);
          add(`${parsed.origin}/csat`);
          add(parsed.origin);
        }catch{}
      }
      return Array.from(endpoints);
    })();
    const deriveCsatPostUrl=endpoint=>{
      if(!endpoint) return '';
      let normalized=String(endpoint).trim();
      if(!normalized) return '';
      normalized=normalized.replace(/\s+/g,'');
      if(/\/csat\/?$/i.test(normalized)){
        return normalized.replace(/\/+$/,'');
      }
      try{
        const url=new URL(normalized);
        const base=`${url.origin}${url.pathname.replace(/\/+$/,'')}`||url.origin;
        return `${base.replace(/\/+$/,'')}/csat`;
      }catch{
        return `${normalized.replace(/\/+$/,'')}/csat`;
      }
    };
    window.CLOUDFLARE_WORKER_URL = CLOUDFLARE_WORKER_URL;
    window.APPS_SCRIPT_URL = APPS_SCRIPT_URL;
    window.CLOUDFLARE_ENC_P256_PUB_JWK = Object.freeze({
      crv: "P-256",
      ext: true,
      key_ops: [],
      kty: "EC",
      x: "uBnUp3ouNZbH8Cq6DMGi1pHJUBCXsNz6d4mxJjnhbu8",
      y: "FlWkYUKQxfsrWFG5Jg3wzfeE5RFEMT2Vw-aKIE2geok"
    });
    const WHATSAPP_NUMBER = "593958741463";
    const BUSINESS = {
      name: "Marxia Café y Bocaditos",
      address: "Av. Principal y Calle A",
      city: "Guayaquil",
      contact: "+593 99 999 9999",
      logo_url: ""
    };

    /* DATA */
    const VAT = 0.15, DELIVERY_FEE = 3.00;
    const PRODUCTS = [
      { id:"p1", name_en:"Option 1", name_es:"Opción 1", price:3.20, desc_en:"Tortilla, Chorizo, Fried Egg, Drink", desc_es:"Tortilla, Chorizo, Huevo frito, Bebida" },
      { id:"p2", name_en:"Option 2", name_es:"Opción 2", price:2.70, desc_en:"Tortilla, Chorizo, Drink", desc_es:"Tortilla, Chorizo, Bebida" },
      { id:"p3", name_en:"Option 3", name_es:"Opción 3", price:2.70, desc_en:"Tortilla, Fried Egg, Drink", desc_es:"Tortilla, Huevo frito, Bebida" },
      { id:"p4", name_en:"Option 4", name_es:"Opción 4", price:6.40, desc_en:"Tortilla, Chorizo, Fried Egg, Drink (Large)", desc_es:"Tortilla, Chorizo, Huevo frito, Bebida (Grande)" },
      { id:"p5", name_en:"Option 5", name_es:"Opción 5", price:2.25, desc_en:"Tortilla, Drink", desc_es:"Tortilla, Bebida" },
    ];

    /* STATE */
    let lang = localStorage.getItem('lang') || 'en';
    let theme = localStorage.getItem('theme') || 'dark';
    const cart = new Map();
    let deliveryMinutes = 45;
    const gps = { lat:null, lng:null, confirmedAt:null };
    let locationStatus = 'idle';
    let locationConfirmed = false;
    window.locationConfirmed = false;

    /* HELPERS */
    const $ = s => document.querySelector(s);
    const track = $('#track');
    const t = (en,es)=> lang==='en'?en:es;
    const fmt = n => '$'+n.toFixed(2);
    const highlightTimers = new WeakMap();
    const metricsBase = WORKER_CSAT_BASE;
    const VISIT_METRICS_STORAGE_KEY='visitMetricsCache';
    const VISIT_METRICS_CACHE_TTL=1000*60*60; // 1 hour
    const VISIT_METRIC_ENDPOINTS=(()=>{
      const set=new Set();
      const add=url=>{ const normalized=normalizeUrlCandidate(url); if(normalized) set.add(normalized); };
      add(joinWorkerPath(metricsBase,'visits'));
      add(joinWorkerPath(metricsBase,'metrics/visits'));
      add(joinWorkerPath(WORKER_CSAT_URL,'visits'));
      add(joinWorkerPath(WORKER_CSAT_URL,'metrics/visits'));
      add(joinWorkerPath(CLOUDFLARE_WORKER_URL,'visits'));
      add(joinWorkerPath(CLOUDFLARE_WORKER_URL,'metrics/visits'));
      return Array.from(set);
    })();

    const parseVisitMetricValue=value=>{
      const num=Number(value);
      if(!Number.isFinite(num) || num<0) return null;
      return Math.round(num);
    };

    const coerceVisitMetrics=input=>{
      if(!input || typeof input!=='object') return null;
      const today=parseVisitMetricValue(input.today ?? input.daily ?? input.day);
      const month=parseVisitMetricValue(input.month ?? input.monthly);
      const year=parseVisitMetricValue(input.year ?? input.annual ?? input.total);
      if(today==null && month==null && year==null) return null;
      return {
        today:today ?? 0,
        month:month ?? 0,
        year:year ?? 0,
      };
    };

    const applyVisitMetrics=(metrics,source='live')=>{
      if(!metrics) return;
      const data=coerceVisitMetrics(metrics);
      if(!data) return;
      updateVisitMetric('visitsToday',data.today);
      updateVisitMetric('visitsMonth',data.month);
      updateVisitMetric('visitsYear',data.year);
      const chartData=[data.today,data.month,data.year];
      drawBarChart('visitsChart',chartData);
      ['visitsToday','visitsMonth','visitsYear'].forEach(id=>{
        const el=document.getElementById(id);
        if(el){
          el.setAttribute('data-source',source);
        }
      });
      if(source==='live'){
        safeStorageSet(VISIT_METRICS_STORAGE_KEY,JSON.stringify({ts:Date.now(),metrics:data}));
      }
    };

    const restoreVisitMetricsFromCache=()=>{
      const raw=safeStorageGet(VISIT_METRICS_STORAGE_KEY);
      if(!raw) return false;
      try{
        const parsed=JSON.parse(raw);
        if(!parsed || typeof parsed!=='object') return false;
        const {ts,metrics}=parsed;
        if(!metrics) return false;
        if(Number.isFinite(ts) && ts>0 && (Date.now()-ts)>VISIT_METRICS_CACHE_TTL) return false;
        applyVisitMetrics(metrics,'cache');
        return true;
      }catch(err){
        console.warn('Unable to parse cached visit metrics.',err);
        return false;
      }
    };

    const applyVisitFallback=reason=>{
      const fallback={today:48,month:1280,year:9820};
      applyVisitMetrics(fallback,reason||'fallback');
    };

    function updateVisitMetric(id,value){
      const el=document.getElementById(id);
      if(!el) return;
      const numeric=Number(value);
      if(!(numeric>0)){
        el.textContent='—';
        el.setAttribute('data-empty','true');
        return;
      }
      el.textContent=numeric.toLocaleString();
      el.removeAttribute('data-empty');
    }
    const MAP_EMBED_TEMPLATES={
      desktop:coords=>`https://www.google.com/maps?q=${coords}&z=17&output=embed`,
      mobile:coords=>`https://maps.google.com/maps?q=${coords}&z=17&output=embed`
    };
    const MAP_SHARE_TEMPLATES={
      desktop:coords=>`https://www.google.com/maps/@${coords},17z`,
      mobile:coords=>`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(coords)}`
    };
    const CSAT_UID_STORAGE_KEY='csatUid';
    const CSAT_FP_STORAGE_KEY='csatFp';

    const csatBytesToHex=bytes=>Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join('');

    const safeStorageGet=key=>{
      try{return localStorage.getItem(key);}catch(err){console.warn(`Unable to read ${key} from storage.`,err);return null;}
    };

    const safeStorageSet=(key,value)=>{
      try{localStorage.setItem(key,value);}catch(err){console.warn(`Unable to persist ${key} to storage.`,err);}
    };

    const deriveCsatFingerprint=async()=>{
      try{
        const components=[
          navigator.userAgent||'',
          navigator.language||'',
          navigator.platform||'',
          String(screen?.width||''),
          String(screen?.height||''),
          String(screen?.colorDepth||''),
          String(window.devicePixelRatio||''),
          Intl.DateTimeFormat?.().resolvedOptions?.().timeZone||''
        ].join('|');
        if(window.crypto?.subtle && window.TextEncoder){
          const data=new TextEncoder().encode(components);
          const digest=await crypto.subtle.digest('SHA-256',data);
          return csatBytesToHex(new Uint8Array(digest));
        }
        return btoa(unescape(encodeURIComponent(components))).slice(0,64);
      }catch(err){
        console.warn('Unable to derive CSAT fingerprint.',err);
        return '';
      }
    };

    const ensureCsatIdentifiers=async()=>{
      let uid=safeStorageGet(CSAT_UID_STORAGE_KEY);
      if(!uid){
        const raw=window.crypto?.randomUUID?.()||`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,10)}`;
        uid=raw.toLowerCase();
        safeStorageSet(CSAT_UID_STORAGE_KEY,uid);
      }
      let fp=safeStorageGet(CSAT_FP_STORAGE_KEY);
      if(!fp){
        fp=await deriveCsatFingerprint();
        if(fp) safeStorageSet(CSAT_FP_STORAGE_KEY,fp);
      }
      return {uid,fp};
    };

    if(typeof window._csatGetIds!=='function'){
      window._csatGetIds=ensureCsatIdentifiers;
    }
    function isMobileOrTablet(){
      try{
        if(navigator.userAgentData && typeof navigator.userAgentData.mobile==='boolean'){
          return navigator.userAgentData.mobile;
        }
      }catch{}
      const ua=(navigator.userAgent||'').toLowerCase();
      if(/mobi|android|iphone|ipad|tablet/.test(ua)) return true;
      return (('ontouchstart' in window)||(navigator.maxTouchPoints||0)>1) && window.innerWidth<1024;
    }
    function detectDefaultMapMode(){
      return isMobileOrTablet()?'mobile':'desktop';
    }
    function coordsForMaps(){
      if(typeof gps.lat==='number' && typeof gps.lng==='number'){
        return `${gps.lat},${gps.lng}`;
      }
      return '';
    }
    function buildMapEmbedUrl(mode){
      const coords=coordsForMaps();
      if(!coords) return '';
      const template=MAP_EMBED_TEMPLATES[mode]||MAP_EMBED_TEMPLATES.desktop;
      return template(coords);
    }
    function buildMapShareUrl(mode){
      const coords=coordsForMaps();
      if(!coords) return '';
      const template=MAP_SHARE_TEMPLATES[mode]||MAP_SHARE_TEMPLATES.desktop;
      return template(coords);
    }
    function mapModeLabel(mode){
      return mode==='mobile'
        ? t('Mobile / Tablet map','Mapa móvil / Tablet')
        : t('PC / Laptop map','Mapa PC / Laptop');
    }
    function formatDeliveryTime(mins){
      if(mins===45) return t('45 min','45 min');
      if(mins===60) return t('1 hr','1 hr');
      if(mins===90) return t('1 hr 30 min','1 hr 30 min');
      return t(`${mins} min`,`${mins} min`);
    }
    function updateDeliveryTimeDisplays(){
      const display=formatDeliveryTime(deliveryMinutes);
      const summary=$('#t_deliveryTime'); if(summary) summary.textContent=display;
      const modalDisplay=$('#m_deliveryTime'); if(modalDisplay) modalDisplay.textContent=display;
    }
    function setPh(el){ const ph = el.getAttribute(lang==='en'?'data-ph-en':'data-ph-es'); if(ph!==null) el.setAttribute('placeholder', ph); }

    const orderDlg = $('#orderDlg');
    const mapDlg = $('#mapDlg');
    const mapFrame = $('#mapFrame');
    const mapStatusEl = $('#mapStatus');
    const locAuthDlg = $('#locAuthDlg');
    const locAuthStatusEl = $('#locAuthStatus');
    const authorizeLocationBtn = $('#authorizeLocationBtn');
    const locAuthCancelBtn = $('#locAuthCancel');
    const closeLocAuthBtn = $('#closeLocAuth');
    const confirmDisclaimer = $('#confirmDisclaimer');
    const locationReviewEl = $('#locationReview');
    const clearReviewBtn = $('#clearReviewBtn');
    const confirmBtnEl = $('#confirmBtn');
    const mapModeButtons = document.querySelectorAll('[data-map-tab]');
    const mapShareLinks = document.querySelectorAll('[data-map-link]');

    let locAuthStatusKey = 'idle';
    let autoOpenMapAfterAuth = true;
    let mapMode = detectDefaultMapMode();

    function highlightMapTabs(){
      mapModeButtons.forEach(btn=>{
        const selected = btn.dataset.mapTab===mapMode;
        btn.classList.toggle('sel',selected);
        btn.setAttribute('aria-pressed',selected?'true':'false');
      });
    }
    function updateMapLinks(){
      const coordsReady = typeof gps.lat==='number' && typeof gps.lng==='number';
      mapShareLinks.forEach(link=>{
        const mode = link.dataset.mapLink;
        const active = mode===mapMode;
        link.dataset.active=active?'true':'false';
        link.classList.toggle('active',active);
        if(coordsReady){
          const url=buildMapShareUrl(mode);
          if(url){
            link.href=url;
          }
          link.classList.remove('disabled');
          link.removeAttribute('aria-disabled');
        }else{
          link.removeAttribute('href');
          link.classList.add('disabled');
          link.setAttribute('aria-disabled','true');
        }
      });
    }
    function setMapMode(mode){
      if(!mode || !(mode in MAP_EMBED_TEMPLATES)) return;
      mapMode = mode;
      highlightMapTabs();
      updateMapView();
      updateMapLinks();
    }

    function renderLocAuthStatus(){
      if(!locAuthStatusEl) return;
      let message='';
      let alert=false;
      switch(locAuthStatusKey){
        case 'requesting':
          message=t('Requesting secure GPS access…','Solicitando acceso seguro al GPS…');
          break;
        case 'error':
          message=t('We could not confirm your delivery location. Enable GPS or adjust permissions, then try again.','No pudimos confirmar su ubicación de entrega. Active el GPS o ajuste los permisos y vuelva a intentarlo.');
          alert=true;
          break;
        case 'success':
          message=t('Location detected. Opening the map so you can verify or update the pin.','Ubicación detectada. Abrimos el mapa para que verifique o actualice el punto.');
          break;
        case 'ready':
          message=t('We already have a saved location. Review or update it on the next step.','Ya tenemos una ubicación guardada. Revísela o actualícela en el siguiente paso.');
          break;
        default:
          message='';
      }
      locAuthStatusEl.textContent=message;
      locAuthStatusEl.classList.toggle('alert',alert);
    }
    function resetLocAuthStatus(){
      if(locationStatus==='error'){
        locAuthStatusKey='error';
      }else if(gps.lat!=null && gps.lng!=null){
        locAuthStatusKey='ready';
      }else{
        locAuthStatusKey='idle';
      }
      renderLocAuthStatus();
    }

    function setLocationConfirmed(val){
      const prev = locationConfirmed;
      locationConfirmed = !!val;
      window.locationConfirmed = locationConfirmed;
      updateLocationReview();
      if(locationConfirmed && !prev){
        document.dispatchEvent(new CustomEvent('delivery-location-confirmed'));
      }
    }
    function openMapForConfirmation(){
      if(mapDlg && typeof mapDlg.showModal==='function'){
        updateMapView();
        if(!mapDlg.open){
          mapDlg.showModal();
        }
      }else if(gps.lat!=null && gps.lng!=null){
        const shareUrl=buildMapShareUrl(mapMode)||buildMapShareUrl('desktop')||buildMapShareUrl('mobile');
        if(shareUrl){
          window.open(shareUrl,'_blank');
        }
        alert(t('The map opened in a new tab so you can verify your delivery pin.','El mapa se abrió en una nueva pestaña para que verifique su punto de entrega.'));
      }else{
        alert(t('We still need your coordinates before the map can load.','Aún necesitamos sus coordenadas antes de cargar el mapa.'));
      }
    }
    function showLocationAuthorization(shouldOpenMap=true){
      autoOpenMapAfterAuth = shouldOpenMap !== false;
      if(locAuthDlg && typeof locAuthDlg.showModal==='function'){
        resetLocAuthStatus();
        locAuthDlg.showModal();
      }else{
        handleAuthorizeLocation();
      }
    }
    async function handleAuthorizeLocation(){
      if(gps.lat!=null && gps.lng!=null){
        if(locAuthDlg && locAuthDlg.open) locAuthDlg.close();
        if(autoOpenMapAfterAuth) openMapForConfirmation();
        return;
      }
      locAuthStatusKey='requesting';
      renderLocAuthStatus();
      if(authorizeLocationBtn){
        authorizeLocationBtn.disabled=true;
        authorizeLocationBtn.setAttribute('aria-busy','true');
      }
      let ok=false;
      try{
        ok=await requestLocation(false);
      }finally{
        if(authorizeLocationBtn){
          authorizeLocationBtn.disabled=false;
          authorizeLocationBtn.removeAttribute('aria-busy');
        }
      }
      if(ok){
        locAuthStatusKey='success';
        renderLocAuthStatus();
        if(locAuthDlg && locAuthDlg.open) locAuthDlg.close();
        if(autoOpenMapAfterAuth) openMapForConfirmation();
      }else{
        locAuthStatusKey='error';
        renderLocAuthStatus();
        if(mapDlg && mapDlg.open){
          setMapStatus(t('We could not confirm your delivery location. Enable GPS or adjust permissions, then try again.','No pudimos confirmar su ubicación de entrega. Active el GPS o ajuste los permisos y vuelva a intentarlo.'),true);
        }
      }
    }
    async function ensureDeliveryLocationConfirmation(){
      if(locationConfirmed){
        return true;
      }
      return new Promise(resolve=>{
        let settled=false;
        const finish=result=>{
          if(settled) return;
          settled=true;
          document.removeEventListener('delivery-location-confirmed', onConfirmed);
          if(mapDlg) mapDlg.removeEventListener('close', onClosed);
          if(locAuthDlg) locAuthDlg.removeEventListener('close', onClosed);
          resolve(result);
        };
        const onConfirmed=()=>finish(true);
        const onClosed=()=>{
          finish(locationConfirmed);
        };
        document.addEventListener('delivery-location-confirmed', onConfirmed);
        if(mapDlg) mapDlg.addEventListener('close', onClosed);
        if(locAuthDlg) locAuthDlg.addEventListener('close', onClosed);
        showLocationAuthorization(true);
      });
    }
    async function ensurePaymentConfirmed(payload){
      if(typeof window.requestPaymentConfirmation==='function'){
        try{
          const result=await window.requestPaymentConfirmation(payload);
          return result===true;
        }catch(err){
          console.error('Payment confirmation callback failed',err);
          return false;
        }
      }
      return confirm(t('Has the payment been confirmed successfully?','¿Se confirmó el pago correctamente?'));
    }
    function formatTimestamp(ts){
      if(!ts) return '';
      const locale = lang==='en' ? 'en-US' : 'es-EC';
      try{
        return new Date(ts).toLocaleString(locale,{hour12:false});
      }catch{
        return ts;
      }
    }
    function formatCoords(){
      if(typeof gps.lat !== 'number' || typeof gps.lng !== 'number') return '';
      return `${gps.lat.toFixed(5)}, ${gps.lng.toFixed(5)}`;
    }
    function buildLocationReview(){
      const coords=formatCoords();
      const when=formatTimestamp(gps.confirmedAt);
      switch(locationStatus){
        case 'pending':
          return {
            review:t('Requesting your delivery location… please allow secure access.','Solicitando su ubicación de entrega… permita el acceso seguro.'),
            state:'pending'
          };
        case 'acquired':
          return {
            review:coords
              ? t(`Location detected (${coords}). Confirm the map to continue.`,`Ubicación detectada (${coords}). Confirme el mapa para continuar.`)
              : t('Location detected. Confirm the map to continue.','Ubicación detectada. Confirme el mapa para continuar.'),
            state:'acquired'
          };
        case 'confirmed':{
          const coordLine=coords
            ? t(`Confirmed coordinates: ${coords}.`,`Coordenadas confirmadas: ${coords}.`)
            : t('Delivery location confirmed.','Ubicación de entrega confirmada.');
          const whenLine=when
            ? t(`Confirmed on ${when}.`,`Confirmado el ${when}.`)
            : '';
          return {
            review:whenLine?`${coordLine} ${whenLine}`:coordLine,
            state:'confirmed'
          };
        }
        case 'error':
          return {
            review:t('We could not confirm your delivery location. Allow GPS access when prompted and try again.','No pudimos confirmar su ubicación de entrega. Permita el acceso GPS cuando se le solicite e inténtelo de nuevo.'),
            state:'error'
          };
        default:
          return {
            review:t('We will ask you to authorize and confirm your delivery location after you click “Confirm Transaction.”','Le pediremos autorizar y confirmar su ubicación de entrega después de presionar “Confirmar transacción”.'),
            state:'idle'
          };
      }
    }

    function updateLocationReview(){
      if(!locationReviewEl) return;
      const {review,state}=buildLocationReview();
      locationReviewEl.textContent=review;
      locationReviewEl.dataset.state=state;
    }
    function disclaimerMessage(key='default'){
      switch(key){
        case 'location':
          return t('Authorize and confirm your delivery location to continue.','Autorice y confirme su ubicación de entrega para continuar.');
        default:
          return t('You must confirm your "Order Delivery Location".','Debe confirmar su "Ubicación de Entrega".');
      }
    }
    function showDisclaimer(message,key='default'){
      if(!confirmDisclaimer) return;
      const msg=message ?? disclaimerMessage(key);
      confirmDisclaimer.hidden=false;
      confirmDisclaimer.dataset.key=key;
      confirmDisclaimer.textContent=msg;
    }
    function hideDisclaimer(){
      if(!confirmDisclaimer) return;
      confirmDisclaimer.hidden=true;
      confirmDisclaimer.textContent='';
      delete confirmDisclaimer.dataset.key;
    }
    function setMapStatus(message,isAlert=false){
      if(!mapStatusEl) return;
      mapStatusEl.textContent=message;
      mapStatusEl.classList.toggle('alert',!!isAlert);
    }
    function updateMapView(){
      if(!mapDlg) return;
      if(mapFrame){
        const baseTitle=t('Delivery location map','Mapa de ubicación de entrega');
        mapFrame.setAttribute('title',`${baseTitle} – ${mapModeLabel(mapMode)}`);
      }
      if(gps.lat!=null && gps.lng!=null){
        const url=buildMapEmbedUrl(mapMode);
        if(mapFrame && url && mapFrame.src!==url){
          mapFrame.src=url;
        }
        setMapStatus(t('Drag and zoom if needed, then confirm your delivery spot.','Arrastre y ajuste si es necesario, luego confirme su punto de entrega.'),false);
      }else{
        if(mapFrame){
          mapFrame.removeAttribute('src');
        }
        if(locationStatus==='error'){
          setMapStatus(t('We could not confirm your delivery location. Enable GPS or adjust permissions, then try again.','No pudimos confirmar su ubicación de entrega. Active el GPS o ajuste los permisos y vuelva a intentarlo.'),true);
        }else{
          setMapStatus(t('We are waiting for your GPS location. Allow access on your device.','Estamos esperando su ubicación GPS. Permita el acceso en su dispositivo.'),true);
        }
      }
      updateMapLinks();
    }

    let locationRequestPromise=null;
    async function requestLocation(auto=false){
      if(!navigator.geolocation){
        locationStatus='error';
        updateLocationReview();
        if(!auto){
          alert(t('Geolocation not supported','Geolocalización no soportada'));
        }
        return false;
      }
      if(locationRequestPromise) return locationRequestPromise;
      locationStatus='pending';
      updateLocationReview();
      if(mapDlg && mapDlg.open){
        setMapStatus(t('Requesting your location...','Solicitando su ubicación...'),false);
      }
      locationRequestPromise=new Promise(resolve=>{
        const onSuccess=pos=>{
          locationRequestPromise=null;
          gps.lat=pos.coords.latitude; gps.lng=pos.coords.longitude; gps.confirmedAt=null;
          setLocationConfirmed(false);
          locationStatus='acquired';
          updateLocationReview();
          updateMapView();
          resolve(true);
        };
        const onError=err=>{
          locationRequestPromise=null;
          gps.lat=null; gps.lng=null; gps.confirmedAt=null;
          setLocationConfirmed(false);
          locationStatus='error';
          updateLocationReview();
          updateMapView();
          if(err && err.code===1){
            alert(t('Location permission required. Please allow access.','Se requiere permiso de ubicación. Por favor permita el acceso.'));
          }else if(!auto){
            alert(t('Could not get location','No se pudo obtener la ubicación'));
          }
          resolve(false);
        };
        const trigger=()=>navigator.geolocation.getCurrentPosition(onSuccess,onError,{enableHighAccuracy:true,timeout:10000});
        if(navigator.permissions){
          navigator.permissions.query({name:'geolocation'}).then(p=>{
            if(p.state==='denied'){
              onError({code:1});
            }else{
              trigger();
            }
          }).catch(()=>trigger());
        }else{
          trigger();
        }
      });
      return locationRequestPromise;
    }

    function resetOrderReview(closeDialog=true){
      cart.clear();
      renderProducts();
      renderModal();
      recalc();
      ['instructions','firstName','lastName','idNumber','phone','email','address'].forEach(id=>{
        const field=$('#'+id);
        if(field){ field.value=''; }
      });
      deliveryMinutes=45;
      document.querySelectorAll('#delTimes .chip').forEach((chip,idx)=>{
        chip.classList.toggle('sel',idx===0);
      });
      updateDeliveryTimeDisplays();
      gps.lat=null; gps.lng=null; gps.confirmedAt=null;
      locationStatus='idle';
      hideDisclaimer();
      setLocationConfirmed(false);
      updateMapView();
      if(mapStatusEl){ setMapStatus('',false); }
      if(mapDlg && mapDlg.open){ mapDlg.close(); }
      if(locAuthDlg && locAuthDlg.open){ locAuthDlg.close(); }
      if(closeDialog){
        $('#orderDlg')?.close();
      }
    }

    function renderProducts(){
      track.innerHTML='';
      PRODUCTS.forEach(p=>{
        const nm = (lang==='en'?p.name_en:p.name_es);
        const ds = (lang==='en'?p.desc_en:p.desc_es);
        const el = document.createElement('article');
        el.className='product card';
        el.innerHTML = `
          <div class="product-image">Product Image</div>
          <div class="product-title">${nm}</div>
          <div class="product-desc">${ds}</div>
          <div class="product-price">${fmt(p.price)}</div>
          <div class="qty" aria-label="${t('Quantity','Cantidad')} ${nm}">
            <button type="button" aria-label="${t('Decrease','Disminuir')}">−</button>
            <input type="text" inputmode="numeric" value="${cart.get(p.id)||0}" aria-label="${t('Quantity','Cantidad')}" />
            <button type="button" aria-label="${t('Increase','Aumentar')}">+</button>
          </div>`;
        const [minus,input,plus]=el.querySelectorAll('.qty>*');
        plus.addEventListener('click',()=>{cart.set(p.id,(cart.get(p.id)||0)+1); input.value=cart.get(p.id); recalc();});
        minus.addEventListener('click',()=>{cart.set(p.id,Math.max(0,(cart.get(p.id)||0)-1)); input.value=cart.get(p.id); recalc();});
        input.addEventListener('input',()=>{const v=Math.max(0,Math.min(999,parseInt(input.value.replace(/\D/g,''))||0)); cart.set(p.id,v); input.value=v; recalc();});
        track.appendChild(el);
      });
    }

    function totals(){
      let sub=0; PRODUCTS.forEach(p=> sub+= p.price*(cart.get(p.id)||0));
      const tax=sub*VAT, del=sub>0?DELIVERY_FEE:0, total=sub+tax+del;
      return {sub,tax,del,total};
    }
    function recalc(){
      const {sub,tax,del,total}=totals();
      $('#t_sub').textContent=fmt(sub); $('#t_tax').textContent=fmt(tax);
      $('#t_del').textContent=fmt(del); $('#t_total').textContent=fmt(total);
    }

    function syncLang(){
      document.querySelectorAll('[data-en]').forEach(el=>{
        if(el.hasAttribute('data-emoji-label')) return;
        const next=el.getAttribute(lang==='en'?'data-en':'data-es');
        if(next!==null) el.textContent=next;
      });
      document.querySelectorAll('[data-ph-en],[data-ph-es]').forEach(setPh);
      $('#langBtn').textContent = lang==='en' ? 'ES' : 'EN';
      renderProducts(); recalc();
      updateDeliveryTimeDisplays();
      $('#m_deliveryTime').previousElementSibling.textContent = t('Delivery Time','Tiempo de entrega');
      if(confirmDisclaimer && !confirmDisclaimer.hidden){
        const key=confirmDisclaimer.dataset.key || 'default';
        showDisclaimer(undefined,key);
      }
      updateLocationReview();
      renderLocAuthStatus();
      if(mapDlg && mapDlg.open) updateMapView();
      if(typeof window.updateCsatSentimentLabel==='function') window.updateCsatSentimentLabel();
      if(typeof window.updateCsatCountsUI==='function') window.updateCsatCountsUI();
      if(window._latestCsatStats) updateCsatSummary(window._latestCsatStats);
    }
    function syncTheme(){
      document.documentElement.setAttribute('data-theme', theme);
      $('#themeBtn').textContent = theme==='light' ? t('Dark','Oscuro') : t('Light','Claro');
    }
    function scrollByCards(d){ const c=track.querySelector('.product'); const dx=c?(c.getBoundingClientRect().width+16):300; track.scrollBy({left:d*dx,behavior:'smooth'}); }

    /* Accordion logic */
    (function(){
      const head = document.querySelector('#zoneAcc .acc-head');
      const body = document.querySelector('#zoneAcc .acc-body');
      head.addEventListener('click', ()=>{
        const open = head.classList.toggle('open');
        head.setAttribute('aria-expanded', open?'true':'false');
        body.style.maxHeight = open ? body.scrollHeight+'px' : '0px';
      });
      // Resize guard
      new ResizeObserver(()=>{ if(head.classList.contains('open')) body.style.maxHeight = body.scrollHeight+'px'; }).observe(body);
    })();

    /* Modal rendering */
    function renderModal(){
      const box=$('#orderItems'); box.innerHTML='';
      PRODUCTS.forEach(p=>{
        const q=cart.get(p.id)||0; if(!q) return;
        const row=document.createElement('div'); row.className='item-row';
        row.innerHTML=`<div><strong>${lang==='en'?p.name_en:p.name_es}</strong>
          <div class="muted text-sm">${lang==='en'?p.desc_en:p.desc_es}</div></div>
          <div class="inline-qty" data-id="${p.id}">
            <button aria-label="${t('Remove','Quitar')}">−</button><span>${q}</span>
            <button aria-label="${t('Add','Agregar')}">+</button></div>`;
        box.appendChild(row);
      });
      box.addEventListener('click', modalQtyHandler, {once:true});
      const {sub,tax,del,total}=totals();
      updateDeliveryTimeDisplays();
      $('#m_sub').textContent=fmt(sub); $('#m_tax').textContent=fmt(tax);
      $('#m_del').textContent=fmt(del); $('#m_total').textContent=fmt(total);
      updateLocationReview();
    }
    function modalQtyHandler(e){
      const box=e.target.closest('.inline-qty'); if(!box) return;
      const id=box.dataset.id; const span=box.querySelector('span');
      if(e.target.textContent==='＋'||e.target.textContent==='+') cart.set(id,(cart.get(id)||0)+1);
      else if(e.target.textContent==='−'||e.target.textContent==='-') cart.set(id,Math.max(0,(cart.get(id)||0)-1));
      else return;
      span.textContent=cart.get(id)||0; recalc(); renderModal();
    }

    /* CSAT rating */
    const ensureCsatStars=source=>{
      const defaults={1:0,2:0,3:0,4:0,5:0};
      if(!source||typeof source!=='object') return defaults;
      const stars={...defaults};
      Object.keys(defaults).forEach(key=>{
        const value=Number(source[key]);
        stars[key]=Number.isFinite(value)&&value>0?value:0;
      });
      return stars;
    };

    const toCsatStats=payload=>{
      if(!payload||typeof payload!=='object') return null;
      const base=(payload.stats&&typeof payload.stats==='object')?payload.stats:payload;
      const averageRaw=base.average??base.avg;
      const totalRaw=base.total??base.count;
      if(averageRaw===undefined && totalRaw===undefined) return null;
      const averageNum=Number(averageRaw);
      const totalNum=Number(totalRaw);
      const average=Number.isFinite(averageNum)?averageNum:0;
      const total=Math.max(0, Number.isFinite(totalNum)?Math.round(totalNum):0);
      const sumCandidate=base.sum??(average*total);
      const sumNum=Number(sumCandidate);
      const sum=Number.isFinite(sumNum)?sumNum:Math.round(average*total)||0;
      const stats={
        average,
        total,
        sum,
        stars:ensureCsatStars(base.stars)
      };
      if(base.updatedAt!==undefined){
        const ts=Number(base.updatedAt);
        if(Number.isFinite(ts)) stats.updatedAt=ts;
      }
      ['today','month','year'].forEach(key=>{
        if(base[key]!==undefined){
          const val=Number(base[key]);
          stats[key]=Number.isFinite(val)?val:0;
        }
      });
      return stats;
    };

    function updateCsatSummary(stats){
      const summaryEl=document.getElementById('csatScore');
      if(!summaryEl) return;
      const normalized=toCsatStats(stats);
      if(!normalized || !(Number(normalized.total)>0)){
        summaryEl.textContent='—';
        summaryEl.hidden=true;
        return;
      }
      const total=Number(normalized.total)||0;
      const average=Number(normalized.average)||0;
      const votesLabel=total===1?t('vote','voto'):t('votes','votos');
      summaryEl.textContent=`${average.toFixed(2)}/5 • ${total.toLocaleString()} ${votesLabel}`;
      summaryEl.hidden=false;
    }

    function showCsatStats(raw){
      const stats=toCsatStats(raw);
      if(!stats) return;
      window._latestCsatStats=stats;
      const avgEl=document.getElementById('csatAverageValue');
      if(avgEl) avgEl.textContent=stats.average.toFixed(2);
      const totalEl=document.getElementById('csatTotalVotes');
      if(totalEl) totalEl.textContent=(stats.total||0).toLocaleString();
      const votesLabel=document.getElementById('csatVotesLabel');
      if(votesLabel){
        const label=lang==='es'?(votesLabel.dataset.es||votesLabel.dataset.en||votesLabel.textContent):
          (votesLabel.dataset.en||votesLabel.textContent);
        votesLabel.textContent=label;
      }
      updateCsatSummary(stats);
    }

    async function logCsatVisit(){
      if(!CSAT_VISIT_ENDPOINT || typeof window._csatGetIds!=='function') return;
      try{
        const { uid, fp } = await window._csatGetIds();
        await fetch(CSAT_VISIT_ENDPOINT,{
          method:'POST',
          headers:{'content-type':'application/json'},
          body:JSON.stringify({ uid, fp, lang, theme: theme || 'dark' })
        });
      }catch(err){
        console.warn('Unable to record CSAT visit.',err);
      }
    }

    function initCsat(){
      let rating=0;
      const stars=Array.from(document.querySelectorAll('.csat-star-btn'));
      const sentimentLabel=document.getElementById('csatSentiment');
      const sentimentMap={
        en:[
          { emoji:'😠', label:'Frustrated' },
          { emoji:'🙁', label:'Unhappy' },
          { emoji:'😐', label:'Neutral' },
          { emoji:'🙂', label:'Happy' },
          { emoji:'🤩', label:'Delighted' }
        ],
        es:[
          { emoji:'😠', label:'Frustrado' },
          { emoji:'🙁', label:'Descontento' },
          { emoji:'😐', label:'Neutral' },
          { emoji:'🙂', label:'Feliz' },
          { emoji:'🤩', label:'Encantado' }
        ]
      };
      const sentimentDefaults={
        en:sentimentLabel?.dataset.defaultEn||'Select a rating',
        es:sentimentLabel?.dataset.defaultEs||'Seleccione una calificación'
      };
      let lastSentimentVal=0;
      const countWrap=document.getElementById('csatCounts');
      let countNodes=countWrap?Array.from(countWrap.querySelectorAll('.csat-count')):[];
      let counts=[0,0,0,0,0];
      const STORAGE_KEY='csatCounts';

      const safeParse=(key,fallback)=>{
        try{
          const raw=localStorage.getItem(key);
          if(!raw) return fallback;
          const parsed=JSON.parse(raw);
          return parsed??fallback;
        }catch(err){
          console.warn(`Unable to read ${key} from storage.`,err);
          return fallback;
        }
      };

      if(countNodes.length===counts.length || !countWrap){
        const saved=safeParse(STORAGE_KEY,[]);
        if(Array.isArray(saved)){
          counts=counts.map((n,i)=>{
            const v=Number(saved[i]);
            return Number.isFinite(v)&&v>=0?Math.floor(v):0;
          });
        }
      }

      const getLeaderRating=()=>{
        let bestIdx=-1;
        let bestVal=-1;
        counts.forEach((val,idx)=>{
          if(val>bestVal || (val===bestVal && idx>bestIdx)){
            bestVal=val;
            bestIdx=idx;
          }
        });
        return bestVal>0?bestIdx+1:0;
      };

      const updateCountsUI=()=>{
        if(countWrap){
          countNodes=Array.from(countWrap.querySelectorAll('.csat-count'));
          countNodes.forEach((node)=>{
            const ratingIdx=(Number(node.dataset.val)||0)-1;
            const val=counts[ratingIdx]||0;
            const label=lang==='en'?(node.dataset.labelEn||''):(node.dataset.labelEs||node.dataset.labelEn||'');
            const text=label?`${label}: ${val}`:`${val} ${t('ratings','calificaciones')}`;
            node.setAttribute('aria-label',text);
            node.setAttribute('title',text);
            node.dataset.count=String(val);
            const score=node.querySelector('.sentiment-score');
            if(score){
              score.textContent=val.toLocaleString();
              score.classList.add('visible');
              score.classList.toggle('zero',val===0);
            }
            const avgDisplay=node.querySelector('.csat-count-average');
            if(avgDisplay){
              const ratingVal=Math.max(0,Math.min(5,Number(node.dataset.val)||0));
              avgDisplay.textContent=(val>0?ratingVal:0).toFixed(2);
            }
            const totalDisplay=node.querySelector('.csat-count-total');
            if(totalDisplay){
              totalDisplay.textContent=val.toLocaleString();
            }
            const votesLabelEl=node.querySelector('.csat-count-votes-label');
            if(votesLabelEl){
              const labelText=lang==='es'?(votesLabelEl.dataset.es||votesLabelEl.dataset.en||votesLabelEl.textContent):
                (votesLabelEl.dataset.en||votesLabelEl.textContent);
              votesLabelEl.textContent=labelText;
            }
          });
          const sorted=[...countNodes].sort((a,b)=>{
            const valA=Number(a.dataset.count)||0;
            const valB=Number(b.dataset.count)||0;
            if(valA===valB){
              return (Number(b.dataset.val)||0)-(Number(a.dataset.val)||0);
            }
            return valB-valA;
          });
          sorted.forEach((node,idx)=>{
            node.classList.toggle('leader',idx===0 && (Number(node.dataset.count)||0)>0);
            countWrap.appendChild(node);
          });
          countNodes=sorted;
        }
        const totalVotes=counts.reduce((sum,val)=>sum+val,0);
        const avg=totalVotes?counts.reduce((sum,val,idx)=>sum+val*(idx+1),0)/totalVotes:0;
        const avgEl=document.getElementById('csatAverageValue');
        if(avgEl) avgEl.textContent=avg.toFixed(2);
        const totalEl=document.getElementById('csatTotalVotes');
        if(totalEl) totalEl.textContent=totalVotes.toLocaleString();
        const votesLabel=document.getElementById('csatVotesLabel');
        if(votesLabel){
          const label=lang==='es'?(votesLabel.dataset.es||votesLabel.dataset.en||votesLabel.textContent):
            (votesLabel.dataset.en||votesLabel.textContent);
          votesLabel.textContent=label;
        }
        if(!rating) paint(0);
      };

      window.updateCsatCountsUI=updateCountsUI;

      const persistCounts=()=>{
        try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(counts)); }
        catch(err){ console.warn('Unable to persist CSAT counts.',err); }
      };

      const updateCounts=(val)=>{
        if(val<1||val>counts.length) return;
        counts[val-1]=(counts[val-1]||0)+1;
        updateCountsUI();
        persistCounts();
      };

      const setSentiment=val=>{
        lastSentimentVal=val>0?val:0;
        if(!sentimentLabel) return;
        const labels=sentimentMap[lang]||sentimentMap.en;
        const fallback=sentimentMap.en;
        const defaultText=sentimentDefaults[lang]||sentimentDefaults.en;
        if(lastSentimentVal>0){
          const idx=Math.max(0,Math.min(labels.length-1,lastSentimentVal-1));
          const entry=labels[idx]||fallback[idx]||fallback[fallback.length-1]||fallback[0];
          const emoji=entry?.emoji||fallback[idx]?.emoji||fallback[2]?.emoji||'🙂';
          const labelText=entry?.label||fallback[idx]?.label||fallback[2]?.label||defaultText;
          sentimentLabel.innerHTML=`<span class="csat-emoji" aria-hidden="true">${emoji}</span><span class="sr-only">${labelText}</span>`;
          sentimentLabel.classList.add('is-emoji');
        }else{
          sentimentLabel.textContent=defaultText;
          sentimentLabel.classList.remove('is-emoji');
        }
      };

      window.updateCsatSentimentLabel=()=>setSentiment(lastSentimentVal);

      const paint=val=>{
        const selectedVal=val>0?val:0;
        const displayVal=selectedVal||getLeaderRating();
        stars.forEach(btn=>{
          const btnVal=Number(btn.dataset.val)||0;
          const isFilled=displayVal>0 && btnVal<=displayVal;
          btn.classList.toggle('active',isFilled);
          btn.setAttribute('aria-pressed',btnVal===selectedVal?'true':'false');
        });
        setSentiment(displayVal);
      };

      const CSAT_ENDPOINT_PREF_KEY='csatEndpointPref';
      let preferredEndpoint=null;
      try{
        const stored=localStorage.getItem(CSAT_ENDPOINT_PREF_KEY);
        if(stored&&WORKER_CSAT_ENDPOINTS.includes(stored)){
          preferredEndpoint=stored;
        }
      }catch(err){
        console.warn('Unable to read CSAT endpoint preference.',err);
      }

      const rememberEndpoint=url=>{
        if(!url) return;
        preferredEndpoint=url;
        try{localStorage.setItem(CSAT_ENDPOINT_PREF_KEY,url);}catch(err){
          console.warn('Unable to persist CSAT endpoint preference.',err);
        }
      };

      const orderedEndpoints=()=>{
        if(!WORKER_CSAT_ENDPOINTS.length) return [];
        const list=[...WORKER_CSAT_ENDPOINTS];
        if(preferredEndpoint){
          const idx=list.indexOf(preferredEndpoint);
          if(idx>0){
            list.splice(idx,1);
            list.unshift(preferredEndpoint);
          }else if(idx===-1){
            list.unshift(preferredEndpoint);
          }
        }
        return list;
      };

      const attemptWorkerRequest=async(endpoint,options={})=>{
        const controller=new AbortController();
        const timer=setTimeout(()=>controller.abort(),options.timeout||6000);
        try{
          const res=await fetch(endpoint,{
            mode:'cors',
            credentials:'omit',
            ...options,
            signal:controller.signal
          });
          let data=null;
          let parsed=false;
          try{data=await res.json();parsed=true;}
          catch{data=null;}
          const explicitFail=parsed && data && typeof data==='object' && (data.ok===false || data.success===false);
          if(!res.ok || explicitFail){
            const message=data && typeof data==='object' && (data.error||data.message)
              ? data.error||data.message
              : `csat_http_${res.status}`;
            const error=new Error(message);
            error.code='server';
            error.status=res.status;
            error.endpoint=endpoint;
            throw error;
          }
          rememberEndpoint(endpoint);
          if(!parsed || data==null){
            return { ok:true };
          }
          if(typeof data==='object' && data.ok===undefined && data.success===undefined){
            data.ok=true;
          }
          return data;
        }finally{
          clearTimeout(timer);
        }
      };

      const sendToWorker=async(entry)=>{
        const endpoints=orderedEndpoints();
        if(!endpoints.length) throw new Error('csat_endpoint_missing');
        const submission={
          rating:entry?.rating,
          lang:entry?.lang
        };
        if(entry && entry.uid!==undefined && entry.uid!==null) submission.uid=entry.uid;
        if(entry && entry.fp!==undefined && entry.fp!==null) submission.fp=entry.fp;
        let lastErr=null;
        for(const endpoint of endpoints){
          try{
            const postUrl=deriveCsatPostUrl(endpoint);
            if(!postUrl) continue;
            return await attemptWorkerRequest(postUrl,{
              method:'POST',
              headers:{'content-type':'application/json'},
              body:JSON.stringify(submission)
            });
          }catch(err){
            if(err.name==='AbortError'){
              err=new Error('csat_timeout');
              err.code='timeout';
            }
            err.endpoint=err.endpoint||endpoint;
            lastErr=err;
            if(classifyNetworkError(err)) break;
            continue;
          }
        }
        throw lastErr||new Error('csat_unreachable');
      };

      const classifyNetworkError=err=>{
        if(!err) return false;
        if(err.name==='AbortError') return true;
        if(err.code==='timeout') return true;
        if(err.code==='server'){
          const status=Number(err.status)||0;
          if(status===429) return true;
          if(status>=500 && status<600) return true;
          return false;
        }
        const msg=(err.message||'').toLowerCase();
        return msg.includes('failed to fetch')||msg.includes('network');
      };

      const queuePending=entry=>{
        pending.push(entry);
        if(pending.length>MAX_PENDING) pending=pending.slice(-MAX_PENDING);
        persistPending();
      };

      const flushPending=async()=>{
        if(!pending.length) return;
        const queue=[...pending];
        pending=[];
        persistPending();
        let latestStats=null;
        for(const entry of queue){
          try{
            const data=await sendToWorker(entry);
            updateCounts(entry.rating);
            const stats=toCsatStats(data);
            if(stats) latestStats=stats;
          }catch(err){
            if(classifyNetworkError(err)){
              pending.push(entry);
            }else{
              console.warn('Dropping CSAT vote due to non-retriable error.',err);
            }
          }
        }
        if(pending.length) persistPending();
        if(latestStats) showCsatStats(latestStats);
      };

      updateCountsUI();

      stars.forEach((btn,i)=>{
        const val=Number(btn.dataset.val)||i+1;
        btn.addEventListener('mouseenter',()=>paint(val));
        btn.addEventListener('focus',()=>paint(val));
        btn.addEventListener('mouseleave',()=>paint(rating));
        btn.addEventListener('blur',()=>paint(rating));
        btn.addEventListener('click',()=>{rating=val;paint(rating);});
      });

      const rateBtn=document.getElementById('rateBtn');
      const setRateBtnBusy=busy=>{
        if(!rateBtn) return;
        rateBtn.disabled=!!busy;
        rateBtn.setAttribute('aria-busy',busy?'true':'false');
        rateBtn.classList.toggle('is-busy',!!busy);
      };
      rateBtn?.addEventListener('click',async()=>{
        if(!rating){
          alert(t('Please select a rating first.','Seleccione una calificación.'));
          return;
        }
        if(rateBtn?.disabled) return;
        let uid;
        let fp;
        if(typeof window._csatGetIds==='function'){
          try{
            const ids=await window._csatGetIds();
            uid=ids?.uid;
            fp=ids?.fp;
          }catch(err){
            console.warn('Unable to resolve CSAT identifiers.',err);
          }
        }
        const entry={rating,lang,uid,fp,ts:Date.now()};
        try{
          const data=await sendToWorker(entry);
          updateCounts(rating);
          const stats=toCsatStats(data);
          if(stats) showCsatStats(stats);
          alert(t('Thanks for rating!','¡Gracias por calificar!'));
          await flushPending();
        }catch(err){
          console.error('CSAT submission failed',err);
          if(classifyNetworkError(err)){
            queuePending(entry);
            alert(t('We saved your rating and will retry as soon as we reconnect.',
              'Guardamos tu calificación y la enviaremos cuando recuperemos la conexión.'));
          }else{
            const fallbackMsg=t('Could not send your rating. Please try again.','No se pudo enviar su calificación. Inténtelo de nuevo.');
            const errMsg=(err&&err.message&&typeof err.message==='string'&&!/^csat_/i.test(err.message))?err.message:fallbackMsg;
            alert(errMsg);
          }
        }
        finally{
          setRateBtnBusy(false);
        }
      });

      paint(0);
      updateCountsUI();

      (async()=>{
        const tried=new Set();
        const candidates=[];
        CSAT_STATS_ENDPOINTS.forEach(endpoint=>{ if(endpoint) candidates.push(endpoint); });
        orderedEndpoints().forEach(endpoint=>{
          if(endpoint) candidates.push(endpoint);
        });
        for(const endpoint of candidates){
          if(!endpoint || tried.has(endpoint)) continue;
          tried.add(endpoint);
          try{
            const data=await attemptWorkerRequest(endpoint,{method:'GET'});
            const stats=toCsatStats(data);
            if(stats){
              showCsatStats(stats);
              return;
            }
            if(data && data.ok) continue;
          }catch(err){
            if(err.name==='AbortError'){
              err.code='timeout';
            }
            if(classifyNetworkError(err)){
              console.warn('CSAT stats unavailable (network)',err);
              break;
            }
            continue;
          }
        }
      })();

      flushPending();
      window.addEventListener('online',flushPending,{once:false});
    }

    /* Simple charts */
    function drawBarChart(id,data){
      const c=document.getElementById(id); if(!c) return;
      const ctx=c.getContext('2d'); const w=c.width,h=c.height;
      ctx.clearRect(0,0,w,h);
      if(!Array.isArray(data) || !data.length) return;
      const safe=data.map(v=>Math.max(0,Number.isFinite(v)?v:Number(v)||0));
      if(!safe.some(v=>v>0)) return;
      const max=Math.max(...safe);
      const barW=w/safe.length-10;
      const color=getComputedStyle(document.documentElement).getPropertyValue('--accent');
      safe.forEach((v,i)=>{
        const x=i*(barW+10)+5; const bh=max>0?(v/max)*h:0;
        ctx.fillStyle=color; ctx.fillRect(x,h-bh,barW,bh);
      });
    }

    function drawLineChart(id,data){
      const c=document.getElementById(id); if(!c) return;
      const ctx=c.getContext('2d'); const w=c.width,h=c.height;
      ctx.clearRect(0,0,w,h);
      if(!Array.isArray(data) || data.length<2) return;
      const safe=data.map(v=>Math.max(0,Number.isFinite(v)?v:Number(v)||0));
      if(!safe.some(v=>v>0)) return;
      const max=Math.max(...safe);
      const step=w/(safe.length-1);
      const color=getComputedStyle(document.documentElement).getPropertyValue('--accent');
      ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath();
      safe.forEach((v,i)=>{
        const x=i*step; const y=h-(max>0?(v/max)*h:0); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke(); ctx.fillStyle=color;
      safe.forEach((v,i)=>{
        const x=i*step; const y=h-(max>0?(v/max)*h:0); ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
      });
    }

    /* INIT */
    renderProducts(); recalc(); syncLang(); syncTheme();
    highlightMapTabs();
    updateMapLinks();
    initCsat();
    logCsatVisit();
    async function loadVisitMetrics(){
      ['visitsToday','visitsMonth','visitsYear'].forEach(id=>updateVisitMetric(id));
      const hadCache=restoreVisitMetricsFromCache();
      if(!metricsBase || !VISIT_METRIC_ENDPOINTS.length){
        if(!hadCache) applyVisitFallback('fallback');
        return;
      }
      for(const endpoint of VISIT_METRIC_ENDPOINTS){
        if(!endpoint) continue;
        const supportsAbort=typeof AbortController!=='undefined';
        let controller=null;
        let timeout=null;
        try{
          if(supportsAbort){
            controller=new AbortController();
            timeout=setTimeout(()=>controller.abort(),8000);
          }
          const response=await fetch(endpoint,{
            mode:'cors',
            credentials:'omit',
            headers:{'Accept':'application/json'},
            signal:controller?.signal,
          });
          if(timeout) clearTimeout(timeout);
          if(!response.ok){
            if(response.status>=500){
              console.warn('Visit metrics endpoint returned server error.',response.status,endpoint);
              continue;
            }
            throw new Error(`bad_status_${response.status}`);
          }
          const payload=await response.json().catch(()=>null);
          const visits=payload?.visits ?? payload;
          if(!visits){
            console.warn('Visit metrics response missing data.',endpoint,payload);
            continue;
          }
          if(!coerceVisitMetrics(visits)){
            console.warn('Visit metrics response contained invalid values.',endpoint,payload);
            continue;
          }
          applyVisitMetrics(visits,'live');
          return;
        }catch(err){
          if(timeout){
            try{clearTimeout(timeout);}catch{}
          }
          if(err?.name==='AbortError'){
            console.warn('Visit metrics request timed out.',endpoint);
            continue;
          }
          if(classifyNetworkError && classifyNetworkError(err)){
            console.warn('Visit metrics request failed (network).',endpoint,err);
            continue;
          }
          console.warn('Unable to load visit metrics.',endpoint,err);
        }
      }
      if(!hadCache) applyVisitFallback('fallback');
    }

    loadVisitMetrics();

    const salesCounts={today:12,month:320,year:2800};
    $('#salesToday').textContent=salesCounts.today;
    $('#salesMonth').textContent=salesCounts.month;
    $('#salesYear').textContent=salesCounts.year;
    drawLineChart('salesChart',[salesCounts.today,salesCounts.month,salesCounts.year]);

    $('#prev').addEventListener('click',()=>scrollByCards(-1));
    $('#next').addEventListener('click',()=>scrollByCards(1));
    $('#langBtn').addEventListener('click',()=>{lang=(lang==='en'?'es':'en');localStorage.setItem('lang',lang);syncLang();});
    $('#themeBtn').addEventListener('click',()=>{theme=(theme==='dark'?'light':'dark');localStorage.setItem('theme',theme);syncTheme();});
    $('#clearBtn').addEventListener('click',e=>{e.preventDefault();cart.clear();renderProducts();recalc();});
    $('#delTimes').addEventListener('click',e=>{
      if(!e.target.classList.contains('chip')) return;
      [...document.querySelectorAll('#delTimes .chip')].forEach(c=>c.classList.remove('sel'));
      e.target.classList.add('sel'); deliveryMinutes=+e.target.dataset.min;
      updateDeliveryTimeDisplays();
    });

    const openPay=()=>{
      renderModal();
      hideDisclaimer();
      mapMode=detectDefaultMapMode();
      highlightMapTabs();
      setLocationConfirmed(false);
      gps.confirmedAt=null;
      locationStatus=(gps.lat!=null&&gps.lng!=null)?'acquired':'idle';
      updateLocationReview();
      updateMapView();
      updateMapLinks();
      orderDlg?.showModal();
    };
    $('#fabPay').addEventListener('click',openPay);
    $('#closeDlg').addEventListener('click',()=>orderDlg?.close());
    $('#cancelBtn').addEventListener('click',()=>orderDlg?.close());
    clearReviewBtn?.addEventListener('click',()=>{
      const confirmReset=confirm(t('Do you want to clear this order review?','¿Desea limpiar esta revisión del pedido?'));
      if(!confirmReset) return;
      resetOrderReview(true);
    });
    orderDlg?.addEventListener('close',()=>{
      hideDisclaimer();
      if(mapDlg && mapDlg.open) mapDlg.close();
      if(locAuthDlg && locAuthDlg.open) locAuthDlg.close();
      setTimeout(()=>{
        setLocationConfirmed(false);
        gps.confirmedAt=null;
        locationStatus=(gps.lat!=null&&gps.lng!=null)?'acquired':'idle';
        updateLocationReview();
      },120);
    });

    if(mapDlg){
      const closeMap=()=>{ mapDlg.close(); };
      $('#closeMap')?.addEventListener('click',closeMap);
      $('#mapCancel')?.addEventListener('click',closeMap);
      mapDlg.addEventListener('cancel',e=>{ e.preventDefault(); mapDlg.close(); });
      mapDlg.addEventListener('close',()=>{
        if(mapFrame) mapFrame.removeAttribute('src');
        setMapStatus('',false);
        if(confirmBtnEl){
          setTimeout(()=>{ confirmBtnEl.focus(); },120);
        }
      });
      $('#mapConfirm')?.addEventListener('click',async ()=>{
        if(gps.lat==null || gps.lng==null){
          setMapStatus(t('We still do not have your coordinates. Please allow GPS access and try again.','Aún no tenemos sus coordenadas. Permita el acceso al GPS e intente nuevamente.'),true);
          await requestLocation(false);
          updateMapView();
          return;
        }
        gps.confirmedAt=new Date().toISOString();
        locationStatus='confirmed';
        setLocationConfirmed(true);
        hideDisclaimer();
        setMapStatus(t('Delivery location confirmed.','Ubicación de entrega confirmada.'),false);
        mapDlg.close();
        if(confirmBtnEl){
          setTimeout(()=>{ confirmBtnEl.focus(); },120);
        }
      });
    }

    if(locAuthDlg){
      const closeLocAuth=()=>{ locAuthDlg.close(); };
      closeLocAuthBtn?.addEventListener('click',closeLocAuth);
      locAuthCancelBtn?.addEventListener('click',closeLocAuth);
      authorizeLocationBtn?.addEventListener('click',()=>{ handleAuthorizeLocation(); });
      locAuthDlg.addEventListener('cancel',e=>{ e.preventDefault(); locAuthDlg.close(); });
      locAuthDlg.addEventListener('close',()=>{
        locAuthStatusKey='idle';
        renderLocAuthStatus();
        if(authorizeLocationBtn){
          authorizeLocationBtn.disabled=false;
          authorizeLocationBtn.removeAttribute('aria-busy');
        }
        if(orderDlg && orderDlg.open && confirmBtnEl){
          setTimeout(()=>{ confirmBtnEl.focus(); },120);
        }
      });
    }else{
      authorizeLocationBtn?.addEventListener('click',()=>{ handleAuthorizeLocation(); });
    }

    mapModeButtons.forEach(btn=>{
      btn.addEventListener('click',()=>{
        const mode=btn.dataset.mapTab;
        if(mode) setMapMode(mode);
      });
    });
    mapShareLinks.forEach(link=>{
      link.addEventListener('click',()=>{
        const mode=link.dataset.mapLink;
        if(mode) setMapMode(mode);
      });
    });

    // Submit to backend + WhatsApp
    $('#confirmBtn').addEventListener('click', async e=>{
      e.preventDefault();

      hideDisclaimer();

      const firstName=$('#firstName').value.trim();
      const lastName=$('#lastName').value.trim();
      const idNumber=$('#idNumber').value.trim();
      const phone=$('#phone').value.trim();
      const email=$('#email').value.trim();
      const address=$('#address').value.trim();
      const instructions=$('#instructions').value.trim();
      const emailOK=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      const phoneOK=/^\+?593\d{9,10}$/.test(phone)||/^0\d{8,9}$/.test(phone);
      if(!firstName||!lastName||!idNumber||!phoneOK||!emailOK||!address){
        alert(t('Please fill all fields with valid data (Name, Last name, Céd/RUC, EC phone, Email, Address).',
                'Complete todos los campos con datos válidos (Nombre, Apellido, Céd/RUC, teléfono EC, Correo, Dirección).')); return;
      }
      const items=PRODUCTS.map(p=>({id:p.id,name:(lang==='en'?p.name_en:p.name_es),desc:(lang==='en'?p.desc_en:p.desc_es),qty:(cart.get(p.id)||0),unit:p.price})).filter(i=>i.qty>0);
      if(!items.length){ alert(t('Your cart is empty.','Su carrito está vacío.')); return; }
      const {sub,tax,del,total}=totals();
      const deliveryDisplay=formatDeliveryTime(deliveryMinutes);

      const locationReady = await ensureDeliveryLocationConfirmation();
      if(!locationReady || !locationConfirmed || gps.lat==null || gps.lng==null){
        showDisclaimer(undefined,'location');
        return;
      }

      const timestamp=new Date().toISOString();
      const desktopMapLink=buildMapShareUrl('desktop');
      const mobileMapLink=buildMapShareUrl('mobile');
      const mapLinks={desktop:desktopMapLink||null,mobile:mobileMapLink||null};
      const gpsData={lat:gps.lat,lng:gps.lng,confirmedAt:gps.confirmedAt};
      const orderPayload={
        lang,
        timestamp,
        business:BUSINESS,
        customer:{firstName,lastName,idNumber,phone,email,address,gps:gpsData,locationConfirmed,city:"",mapLinks},
        delivery:{minutes:deliveryMinutes,fee:DELIVERY_FEE,included:true,display:deliveryDisplay},
        cart:{items,subtotal:sub,vat:tax,delivery:del,total,instructions}
      };
      if(!mapLinks.desktop && !mapLinks.mobile){
        delete orderPayload.customer.mapLinks;
      }
      const paymentPayload={
        lang,
        timestamp,
        business:BUSINESS,
        customer:{firstName,lastName,address},
        delivery:orderPayload.delivery,
        cart:{items,subtotal:sub,vat:tax,delivery:del,total}
      };

      const paymentConfirmed = await ensurePaymentConfirmed(paymentPayload);
      if(!paymentConfirmed){
        alert(t('We will wait for the payment confirmation before sending the order.','Esperaremos la confirmación del pago antes de enviar el pedido.'));
        return;
      }

      let workerInitToken = '';
      if(typeof window.initializeWorkerTransaction==='function'){
        try{
          const workerResult = await window.initializeWorkerTransaction(orderPayload,{ policy:'OPS' });
          if(workerResult && workerResult.ok && workerResult.token){
            workerInitToken = String(workerResult.token);
          }else if(workerResult && workerResult.error){
            console.warn('Worker initialization error:', workerResult.error);
          }
        }catch(err){
          console.error('Unable to initialize encrypted worker transaction.',err);
        }
      }

      if(typeof window.forwardPIIToWorker==='function'){
        try{
          await window.forwardPIIToWorker();
        }catch(err){
          console.error('Secure PII forwarding failed.',err);
        }
      }

      try{
        if(CLOUDFLARE_WORKER_URL){
          await fetch(CLOUDFLARE_WORKER_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...orderPayload,apps_script_url:APPS_SCRIPT_URL})});
        }else if(APPS_SCRIPT_URL){
          await fetch(APPS_SCRIPT_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(orderPayload)});
        }
      }

      catch(e){ console.warn("Backend request failed:",e); }
      let maps='';
      if(locationConfirmed && gps.lat!=null && gps.lng!=null){
        const mapLines=[];
        if(desktopMapLink){
          mapLines.push(`${t('Map (PC/Laptop)','Mapa (PC/Portátil)')}: ${desktopMapLink}`);
        }
        if(mobileMapLink){
          mapLines.push(`${t('Map (Mobile/Tablet)','Mapa (Móvil/Tablet)')}: ${mobileMapLink}`);
        }
        if(mapLines.length){
          maps=`\n${mapLines.join('\n')}`;
        }
      }
      const confirmationLine = locationConfirmed && gps.confirmedAt
        ? `${t('Location confirmed at','Ubicación confirmada el')} ${formatTimestamp(gps.confirmedAt)}`
        : t('Location confirmation pending','Confirmación de ubicación pendiente');
      const lines=items.map(i=>`• ${i.name} x${i.qty} = ${fmt(i.qty*i.unit)}`).join("\n");
      const msg=`${t('Order','Pedido')} – ${BUSINESS.name}\n\n${t('Customer','Cliente')}: ${firstName} ${lastName}\nID: ${idNumber}\nTel: ${phone}\nEmail: ${email}\nDir: ${address}${maps}\n${confirmationLine}\n\n${t('Items Purchased','Artículos')}\n${lines}\n\n${t('Delivery Time','Tiempo de entrega')}: ${deliveryDisplay}\nSubtotal: ${fmt(sub)}\n${t('VAT 15%','IVA 15%')}: ${fmt(tax)}\n${t('Delivery','Entrega')}: ${fmt(del)}\n${t('Total','Total')}: ${fmt(total)}\n\n${t('Instructions','Instrucciones')}: ${instructions||'-'}`;
      window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`,'_blank');
      $('#orderDlg').close();
      const tokenLine = workerInitToken
        ? `\n${t('Transaction token','Token de transacción')}: ${workerInitToken}`
        : '';
      alert(`${t('Order sent. We also opened WhatsApp with the details.','Pedido enviado. También abrimos WhatsApp con los detalles.')}${tokenLine}`);
    });

    document.addEventListener('click',e=>{
      const interactive=e.target.closest('button, a');
      if(!interactive) return;
      interactive.classList.add('click-highlight');
      if(highlightTimers.has(interactive)) clearTimeout(highlightTimers.get(interactive));
      const timer=setTimeout(()=>{
        interactive.classList.remove('click-highlight');
        highlightTimers.delete(interactive);
      },3000);
      highlightTimers.set(interactive,timer);
    });

    // Keyboard arrows for carousel
    document.addEventListener('keydown',e=>{ if(e.key==='ArrowLeft')scrollByCards(-1); if(e.key==='ArrowRight')scrollByCards(1); });
  </script>
  <script nonce="2726c7f26c" src="rofrigastreo.js" integrity="sha384-nx6qcrWiIVIiVr/lfG7ZPfGYm5W8HK5j8hlm20FKjM/pAwi5KqEnyhPgnAjTli+V" crossorigin="anonymous"></script>
</body>
</html>
